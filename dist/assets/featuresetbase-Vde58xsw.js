import{aS as Ie,w as se,B as I,F,J as te,bl as Te,dp as ve,U as Re,v as Me,ij as Oe,j as Ge,y as Ve,dF as y,dG as w,dL as P,dP as ze,dK as U,ik as Je,C as Ee,b2 as He,fW as We,dr as Ze,ct as O,il as Ke,ac as Be}from"./index-DzoQLc5A.js";import{t as qe,D as _e,l as ue}from"./arcadeUtils-B5o1WIuc.js";import{a as S,E as Qe,F as de,K as L,j as G,p as x,a0 as Xe,l as De,A as ke,a1 as Se,q as R,V as X,$ as ne,b as _,a2 as Ye,G as et,N as Y,a3 as tt,a4 as xe,a5 as ie,a6 as ce}from"./aiServices-CwoakPkn.js";import{R as nt,q as je,p as it,c as fe,e as rt,a as ot,b as at,N as oe,j as st,F as lt,E as ut,L as q,B as dt,d as re,f as M,k as me}from"./featureSetUtils-DF4fTtj3.js";import{l as ct}from"./portalUtils-J2lwjXKt.js";import{u as ft,O as Ae}from"./SpatialFilter-BnGRtocU.js";import{R as E}from"./WhereClause-C4sLVd4N.js";import{f as mt,u as pt,s as yt}from"./utils-DDykF6ND.js";import"https://js.arcgis.com/map-components/4.33/arcgis-map-components.esm.js";import"./featureConversionUtils-4vS7e9DV.js";import"./OptimizedFeature-DdLiUxBt.js";import"./memoryEstimations-Cau39Oyv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./unitConversion-BxJeRrtg.js";import"./number-BUyyDjIe.js";import"./commonProperties-DHiB1uzW.js";import"./operatorsWorkerConnection-CcK_JfO_.js";var Ce;(function(t){t[t.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",t[t.RTContainment=2]="RTContainment",t[t.RTAttachment=3]="RTAttachment",t[t.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",t[t.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(Ce||(Ce={}));new Ie({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const H=new Ie({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new Ie({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let j=class extends se{constructor(s){super(s),this.type="networkElement",this.assetGroupCode=null,this.assetTypeCode=null,this.globalId=null,this.networkSourceId=null,this.objectId=null,this.positionFrom=null,this.positionTo=null,this.terminalId=null}};I([F({json:{write:!1}})],j.prototype,"type",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"assetGroupCode",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"assetTypeCode",void 0),I([F({type:String,json:{write:!0}})],j.prototype,"globalId",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"networkSourceId",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"objectId",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"positionFrom",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"positionTo",void 0),I([F({type:Number,json:{write:!0}})],j.prototype,"terminalId",void 0),j=I([te("esri.rest.networks.support.NetworkElement")],j);let Q=class extends j{constructor(t){super(t),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};I([F({json:{write:!1}})],Q.prototype,"type",void 0),I([F({json:{write:!0}})],Q.prototype,"firstUnit",void 0),I([F({json:{write:!0}})],Q.prototype,"numUnits",void 0),Q=I([te("esri.rest.networks.support.TelecomNetworkElement")],Q);let C=class extends se{constructor(t){super(t),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(t,s){return s.fromFirstUnit||s.fromNumUnits?new Q({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId,firstUnit:s.fromFirstUnit,numUnits:s.fromNumUnits}):new j({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId})}writeFromNetworkElement(t,s){if(t&&(s.fromGlobalId=t.globalId,s.fromNetworkSourceId=t.networkSourceId,s.fromTerminalId=t.terminalId,t.type==="telecomNetworkElement")){const n=t;s.fromFirstUnit=n.firstUnit,s.fromNumUnits=n.numUnits}}readToNetworkElement(t,s){return s.toFirstUnit||s.toNumUnits?new Q({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId,firstUnit:s.toFirstUnit,numUnits:s.toNumUnits}):new j({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId})}writeToNetworkElement(t,s){if(t&&(s.toGlobalId=t.globalId,s.toNetworkSourceId=t.networkSourceId,s.toTerminalId=t.terminalId,t.type==="telecomNetworkElement")){const n=t;s.toFirstUnit=n.firstUnit,s.toNumUnits=n.numUnits}}};I([F({type:String,json:{write:!0}})],C.prototype,"globalId",void 0),I([F({type:H.apiValues,json:{type:H.jsonValues,read:H.read,write:H.write}})],C.prototype,"associationType",void 0),I([F({type:j,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],C.prototype,"fromNetworkElement",void 0),I([Te("fromNetworkElement")],C.prototype,"readFromNetworkElement",null),I([ve("fromNetworkElement")],C.prototype,"writeFromNetworkElement",null),I([F({type:j,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],C.prototype,"toNetworkElement",void 0),I([Te("toNetworkElement")],C.prototype,"readToNetworkElement",null),I([ve("toNetworkElement")],C.prototype,"writeToNetworkElement",null),I([F({type:Re,json:{write:!0}})],C.prototype,"geometry",void 0),I([F({type:String,json:{write:!0}})],C.prototype,"errorMessage",void 0),I([F({type:Number,json:{write:!0}})],C.prototype,"percentAlong",void 0),I([F({type:Number,json:{write:!0}})],C.prototype,"errorCode",void 0),I([F({type:Boolean,json:{write:!0}})],C.prototype,"isContentVisible",void 0),I([F({type:Number,json:{write:!0}})],C.prototype,"status",void 0),C=I([te("esri.rest.networks.support.Association")],C);let ae=class extends se{constructor(s){super(s),this.associations=[]}};I([F({type:[C],json:{write:!0}})],ae.prototype,"associations",void 0),ae=I([te("esri.rest.networks.support.QueryAssociationsResult")],ae);function wt(t){const{returnDeletes:s,elements:n,gdbVersion:r,moment:g}=t.toJSON();return{returnDeletes:s,elements:JSON.stringify(n.map((h=>({globalId:h.globalId,networkSourceId:h.networkSourceId,terminalId:h.terminalId})))),types:JSON.stringify(t.types.map((h=>H.toJSON(h)))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:r,moment:g??Date.now()}}async function It(t,s,n){const r=mt(t),g={...wt(s),f:"json"},h=pt({...r.query,...g}),e=yt(h,{...n,method:"post"}),i=`${r.path}/associations/query`,{data:a}=await Me(i,e),l=ae.fromJSON(a);return s.types.includes("connectivity")&&Oe(Ge.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),l}var ye;let B=ye=class extends se{static from(t){return Ve(ye,t)}constructor(t){super(t),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};I([F({type:Boolean,json:{write:!0}})],B.prototype,"returnDeletes",void 0),I([F({type:[j],json:{write:!0}})],B.prototype,"elements",void 0),I([F({type:[H.apiValues],json:{type:H.jsonValues,read:H.read,write:H.write}})],B.prototype,"types",void 0),I([F({type:String,json:{write:!0}})],B.prototype,"gdbVersion",void 0),I([F({type:Date,json:{type:Number,write:{writer:(t,s)=>{s.moment=t==null?void 0:t.getTime()}}}})],B.prototype,"moment",void 0),B=ye=I([te("esri.rest.networks.support.QueryAssociationsParameters")],B);function gt(t){if(t.length===1){if(U(t[0]))return ue("distinct",t[0],-1);if(_(t[0]))return ue("distinct",t[0].toArray(),-1)}return ue("distinct",t,-1)}function pe(t,s,n){const r=t.getVariables();if(r.length>0){const g={};for(const h of r)g[h]=s.evaluateIdentifier(n,{name:h});t.parameters=g}return t}function f(t,s,n=null){for(const r in t)if(r.toLowerCase()===s.toLowerCase())return t[r];return n}function Ue(t){if(t===null)return null;const s={type:f(t,"type",""),name:f(t,"name","")};if(s.type==="range")s.range=f(t,"range",[]);else{s.codedValues=[];for(const n of f(t,"codedValues",[]))s.codedValues.push({name:f(n,"name",""),code:f(n,"code",null)})}return s}function we(t){if(t===null)return null;const s={},n=f(t,"wkt");n!==null&&(s.wkt=n);const r=f(t,"wkid");return r!==null&&(s.wkid=r),s}function Le(t){if(t===null)return null;const s={hasZ:f(t,"hasz",!1),hasM:f(t,"hasm",!1)},n=f(t,"spatialreference");n!=null&&(s.spatialReference=we(n));const r=f(t,"x",null);if(r!==null)return s.x=r,s.y=f(t,"y",null),s.hasZ&&(s.z=f(t,"z",null)),s.hasM&&(s.m=f(t,"m",null)),s;const g=f(t,"rings",null);if(g!==null)return s.rings=g,s;const h=f(t,"paths",null);if(h!==null)return s.paths=h,s;const e=f(t,"points",null);if(e!==null)return s.points=e,s;for(const i of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=f(t,i,null);a!==null&&(s[i]=a)}return s}function ht(t,s){for(const n of s)if(n===t)return!0;return!1}function bt(t){return!!t.layerDefinition&&!!t.featureSet&&ht(t.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&U(t.layerDefinition.fields)!==!1&&U(t.featureSet.features)!==!1}function ee(t){return(t==null?void 0:t.toLowerCase())==="utc"?"UTC":(t==null?void 0:t.toLowerCase())==="unknown"?"Unknown":t}async function Ft(t,s,n,r,g,h,e){var d,m,D;const i=await t.getFeatureSetInfo();if(((i==null?void 0:i.layerId)??null)===null||!g.layerIdLookup.get(i.layerId))return null;const a=t.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),l=[];switch(n){case"connected":l.push("connectivity"),l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity"),l.push("junction-edge-midspan-connectivity"),l.push("junction-junction-connectivity");break;case"container":case"content":l.push("containment");break;case"structure":case"attached":l.push("attachment");break;case"junctionedge":l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity");break;case"midspan":l.push("junction-edge-midspan-connectivity");break;default:throw new y(h,w.InvalidParameter,e)}let p=null,c=!1;if(r!==null&&r!==""&&r!==void 0){for(const b of g.terminals)b.terminalName===r&&(p=b.terminalId);p===null&&(c=!0)}const u=[];if(!c){const b=new j({globalId:s.field(t.globalIdField),networkSourceId:g.layerIdLookup.get(i.layerId).sourceId,...p?{terminalId:p}:""}),v=await It(a,new B({types:l,elements:[b]}));let k=0;for(const A of v.associations){let V=null,z="",Z="";if(((d=A.fromNetworkElement)==null?void 0:d.globalId)===b.globalId?(V=A.toNetworkElement,Z="to"):((m=A.toNetworkElement)==null?void 0:m.globalId)===b.globalId&&(V=A.fromNetworkElement,Z="from"),!V)continue;switch(n){case"attached":if(A.associationType!=="attachment"||Z!=="to")continue;break;case"structure":if(A.associationType!=="attachment"||Z!=="from")continue;break;case"container":if(A.associationType!=="containment"||Z!=="from")continue;break;case"content":if(A.associationType!=="containment"||Z!=="to")continue;break;case"connected":break;case"junctionedge":A.associationType==="junction-edge-to-connectivity"?z="to":A.associationType==="junction-edge-from-connectivity"&&(z="from");break;case"midspan":if(A.associationType!=="junction-edge-midspan-connectivity")continue}const J=((D=g.sourceIdLookup.get(V.networkSourceId))==null?void 0:D.className)??"";u.push(new Be({geometry:null,attributes:{objectId:k++,globalId:V.globalId,percentAlong:A.percentAlong??0,isContentVisible:A.isContentVisible?0:1,className:J,side:z}}))}}const o=new Ze({source:u,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new O({name:"objectId",alias:"objectId",type:"oid"}),new O({name:"globalId",alias:"globalId",type:"global-id"}),new O({name:"percentAlong",alias:"percentAlong",type:"double"}),new O({name:"side",alias:"side",type:"string"}),new O({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new O({name:"className",alias:"className",type:"string"})]});return oe(o)}function Gt(t){if(t.mode==="async"){t.functions.timezone=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{var l,p;if(S(e,1,2,n,r),Qe(e[0])||de(e[0]))return"Unknown";if(L(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?ee("unknown"):ee(e[0].dateFieldsTimeZone);if(!(e[1]instanceof G)||e[1].hasField("type")===!1)throw new y(n,w.InvalidParameter,r);const c=e[1].field("type");if(P(c)===!1)throw new y(n,w.InvalidParameter,r);switch(x(c).toLowerCase()){case"preferredtimezone":return ee(e[0].preferredTimeZone);case"editfieldsinfo":return ee(((l=e[0].editFieldsInfo)==null?void 0:l.timeZone)??null);case"timeinfo":return ee(((p=e[0].timeInfo)==null?void 0:p.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&P(e[1].field("fieldname")))return ee(e[0].fieldTimeZone(x(e[1].field("fieldname"))))}throw new y(n,w.InvalidParameter,r)}const i=Xe(e[0],De(n));if(i===null)return null;const a=i.timeZone;return a==="system"?ze.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a}))},t.functions.sqltimestamp=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{S(e,1,3,n,r);const i=e[0];if(ke(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(x(e[1])).toSQLWithKeyword();throw new y(n,w.InvalidParameter,r)}if(de(i))return i.toSQLWithKeyword();if(L(i)){if(e.length!==3)throw new y(n,w.InvalidParameter,r);await i.load();const a=x(e[1]);if(de(e[2]))return e[2].toSQLWithKeyword();if(ke(e[2])===!1)throw new y(n,w.InvalidParameter,r);const l=i.fieldTimeZone(a);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"sqltimestamp",min:2,max:4}),t.functions.featuresetbyid=function(n,r){return t.standardFunctionAsync(n,r,((g,h,e)=>{if(S(e,2,4,n,r),Se(e[0])){const i=x(e[1]);let a=R(e[2],null);const l=X(R(e[3],!0));if(a===null&&(a=["*"]),U(a)===!1)throw new y(n,w.InvalidParameter,r);return e[0].featureSetById(i,l,a)}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"featuresetbyid",min:2,max:4});const s=new Je(["datasource","parent","root"]);t.functions.getfeatureset=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,1,2,n,r),ne(e[0])){const i=e[1]==null?"datasource":s.lookup(x(e[1]));return nt(e[0].fullSchema(),i,n.lrucache,n.interceptor,n.spatialReference)}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"getfeatureset",min:1,max:2}),t.functions.featuresetbyportalitem=function(n,r){return t.standardFunctionAsync(n,r,((g,h,e)=>{var c,u;if(S(e,2,5,n,r),e[0]===null)throw new y(n,w.PortalRequired,r);if(e[0]instanceof qe){const o=x(e[1]),d=x(e[2]);let m=R(e[3],null);const D=X(R(e[4],!0));if(m===null&&(m=["*"]),U(m)===!1)throw new y(n,w.InvalidParameter,r);let b;return b=(c=n.services)!=null&&c.portal?n.services.portal:Ee.getDefault(),b=ct(e[0],b),je(o,d,n.spatialReference,m,D,b,n.lrucache,n.interceptor)}if(P(e[0])===!1)throw new y(n,w.PortalRequired,r);const i=x(e[0]),a=x(e[1]);let l=R(e[2],null);const p=X(R(e[3],!0));if(l===null&&(l=["*"]),U(l)===!1)throw new y(n,w.InvalidParameter,r);return je(i,a,n.spatialReference,l,p,((u=n.services)==null?void 0:u.portal)??Ee.getDefault(),n.lrucache,n.interceptor)}))},t.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),t.functions.featuresetbyname=function(n,r){return t.standardFunctionAsync(n,r,((g,h,e)=>{if(S(e,2,4,n,r),Se(e[0])){const i=x(e[1]);let a=R(e[2],null);const l=X(R(e[3],!0));if(a===null&&(a=["*"]),U(a)===!1)throw new y(n,w.InvalidParameter,r);return e[0].featureSetByName(i,l,a)}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"featuresetbyname",min:2,max:4}),t.functions.featureset=function(n,r){return t.standardFunction(n,r,((g,h,e)=>{S(e,1,1,n,r);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(P(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(i.layerDefinition=a.layerDefinition,i.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(i.featureSet.features=a.features,i.featureSet.geometryType=a.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=a.objectIdFieldName??"",i.layerDefinition.typeIdField=a.typeIdFieldName,i.layerDefinition.globalIdField=a.globalIdFieldName,i.layerDefinition.fields=a.fields,a.spatialReference&&(i.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof G))throw new y(n,w.InvalidParameter,r);{const a=JSON.parse(e[0].castToText(!0)),l=f(a,"layerdefinition");if(l!==null){i.layerDefinition.geometryType=f(l,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=f(l,"globalidfield",""),i.layerDefinition.objectIdField=f(l,"objectidfield",""),i.layerDefinition.typeIdField=f(l,"typeidfield",""),i.layerDefinition.hasZ=f(l,"hasz",!1)===!0,i.layerDefinition.hasM=f(l,"hasm",!1)===!0;const p=f(l,"spatialreference");p&&(i.layerDefinition.spatialReference=we(p));const c=[];for(const o of f(l,"fields",[])){const d={name:f(o,"name",""),alias:f(o,"alias",""),type:f(o,"type",""),nullable:f(o,"nullable",!0),editable:f(o,"editable",!0),length:f(o,"length",null),domain:Ue(f(o,"domain"))};c.push(d)}i.layerDefinition.fields=c;const u=f(a,"featureset");if(u){const o={};for(const d of c)o[d.name.toLowerCase()]=d.name;for(const d of f(u,"features",[])){const m={},D=f(d,"attributes",{});for(const b in D)m[o[b.toLowerCase()]]=D[b];i.featureSet.features.push({attributes:m,geometry:Le(f(d,"geometry"))})}}}else{i.layerDefinition.hasZ=f(a,"hasz",!1)===!0,i.layerDefinition.hasM=f(a,"hasm",!1)===!0,i.layerDefinition.geometryType=f(a,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=f(a,"objectidfieldname",""),i.layerDefinition.typeIdField=f(a,"typeidfieldname","");const p=f(a,"spatialreference");p&&(i.layerDefinition.spatialReference=we(p));const c=[],u=f(a,"fields",null);if(!U(u))throw new y(n,w.InvalidParameter,r);for(const m of u){const D={name:f(m,"name",""),alias:f(m,"alias",""),type:f(m,"type",""),nullable:f(m,"nullable",!0),editable:f(m,"editable",!0),length:f(m,"length",null),domain:Ue(f(m,"domain"))};c.push(D)}i.layerDefinition.fields=c;const o={};for(const m of c)o[m.name.toLowerCase()]=m.name;let d=f(a,"features",null);if(U(d))for(const m of d){const D={},b=f(m,"attributes",{});for(const v in b)D[o[v.toLowerCase()]]=b[v];i.featureSet.features.push({attributes:D,geometry:Le(f(m,"geometry",null))})}else d=null,i.featureSet.features=d}}}if(bt(i)===!1)throw new y(n,w.InvalidParameter,r);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),it.create(i,n.spatialReference)}))},t.signatures.push({name:"featureset",min:1,max:1}),t.functions.filter=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,2,2,n,r),U(e[0])||_(e[0])){const i=[];let a,l=e[0];if(l instanceof Ye&&(l=l.toArray()),!et(e[1]))throw new y(n,w.InvalidParameter,r);a=e[1].createFunction(n);for(const p of l){const c=a(p);He(c)?await c===!0&&i.push(p):c===!0&&i.push(p)}return i}if(L(e[0])){const i=await e[0].load(),a=E.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),l=a.getVariables();if(l.length>0){const p={};for(const c of l)p[c]=t.evaluateIdentifier(n,{name:c});a.parameters=p}return new fe({parentfeatureset:e[0],whereclause:a})}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"filter",min:2,max:2}),t.functions.orderby=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,2,2,n,r),L(e[0])){const i=new rt(e[1]);return new ot({parentfeatureset:e[0],orderbyclause:i})}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"orderby",min:2,max:2}),t.functions.top=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,2,2,n,r),L(e[0]))return new at({parentfeatureset:e[0],topnum:e[1]});if(U(e[0]))return Y(e[1])>=e[0].length?e[0].slice():e[0].slice(0,Y(e[1]));if(_(e[0]))return Y(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,Y(e[1]));throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"top",min:2,max:2}),t.functions.first=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,1,1,n,r),L(e[0])){const i=await e[0].first(g.abortSignal);if(i!==null){const a=_e.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],n.timeZone);return a._underlyingGraphic=i,a}return i}return U(e[0])?e[0].length===0?null:e[0][0]:_(e[0])?e[0].length()===0?null:e[0].get(0):null}))},t.signatures.push({name:"first",min:1,max:1}),t.functions.attachments=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{S(e,1,2,n,r);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof G){if(e[1].hasField("minsize")&&(i.minsize=Y(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=X(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=Y(e[1].field("maxsize"))),e[1].hasField("types")){const a=tt(e[1].field("types"),!1);a.length>0&&(i.types=a)}}else if(e[1]!==null)throw new y(n,w.InvalidParameter,r)}if(ne(e[0])){const a=e[0]._layer;let l;if(L(a))l=a;else{if(a==null||!xe(a))return[];l=oe(a,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"attachments",min:1,max:2}),t.functions.featuresetbyrelationshipname=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{S(e,2,4,n,r);const i=e[0],a=x(e[1]);let l=R(e[2],null);const p=X(R(e[3],!0));if(l===null&&(l=["*"]),U(l)===!1)throw new y(n,w.InvalidParameter,r);if(e[0]===null)return null;if(!ne(e[0]))throw new y(n,w.InvalidParameter,r);const c=i._layer;let u;if(L(c))u=c;else{if(c==null||!xe(c))return null;u=oe(c,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}u=await u.load();const o=u.relationshipMetaData().filter((v=>v.name===a));if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return st(u,o[0],i.field(u.objectIdField),u.spatialReference,l,p,n.lrucache,n.interceptor);let d=u.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const m=await lt(d,u.spatialReference,l,p,n.lrucache,n.interceptor);await m.load();let D=m.relationshipMetaData();if(D=D.filter((v=>v.id===o[0].id)),i.hasField(o[0].keyField)===!1||i.field(o[0].keyField)===null){const v=await u.getFeatureByObjectId(i.field(u.objectIdField),[o[0].keyField]);if(v){const k=E.create(D[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return k.parameters={id:v.attributes[o[0].keyField]},m.filter(k)}return new ft({parentfeatureset:m})}const b=E.create(D[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return b.parameters={id:i.field(o[0].keyField)},m.filter(b)}))},t.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),t.functions.featuresetbyassociation=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{S(e,2,3,n,r);const i=e[0],a=We(x(R(e[1],""))),l=P(e[2])?x(e[2]):null;if(e[0]===null)return null;if(!ne(e[0]))throw new y(n,w.InvalidParameter,r);let p=i._layer;if(p instanceof Ze&&(p=oe(p,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),p===null||L(p)===!1)return null;await p.load();const c=p.serviceUrl(),u=await ut(c,n.spatialReference,!0);if(u.unVersion>=8)return await Ft(p,i,a,l,u,n,r);const o=u.associations;let d=null,m=null,D=!1;if(l!==null&&l!==""&&l!==void 0){for(const T of u.terminals)T.terminalName===l&&(m=T.terminalId);m===null&&(D=!0)}const b=o.getFieldsIndex(),v=b.get("TOGLOBALID").name,k=b.get("FROMGLOBALID").name,A=b.get("TOTERMINALID").name,V=b.get("FROMTERMINALID").name,z=b.get("FROMNETWORKSOURCEID").name,Z=b.get("TONETWORKSOURCEID").name,J=b.get("ASSOCIATIONTYPE").name,$e=b.get("ISCONTENTVISIBLE").name,Pe=b.get("OBJECTID").name;for(const T of p.fields)if(T.type==="global-id"){d=i.field(T.name);break}let W=null,ge=new q(new O({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),he=new q(new O({name:"side",alias:"side",type:"string"}),E.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const $="globalid",be="globalId",Fe={};for(const T in u.lkp)Fe[T]=u.lkp[T].sourceId;const K=new dt(new O({name:"classname",alias:"classname",type:"string"}),null,Fe);let N="";switch(a){case"midspan":{N=`((${v}='${d}') OR ( ${k}='${d}')) AND (${J} IN (5))`,K.codefield=E.create(`CASE WHEN (${v}='${d}') THEN ${z} ELSE ${Z} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const T=ce(M.findField(o.fields,k));T.name=$,T.alias=$,W=new q(T,E.create(`CASE WHEN (${k}='${d}') THEN ${v} ELSE ${k} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=u.unVersion>=4?new me(M.findField(o.fields,b.get("PERCENTALONG").name)):new q(new O({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{N=`((${v}='${d}') OR ( ${k}='${d}')) AND (${J} IN (4,6))`,K.codefield=E.create(`CASE WHEN (${v}='${d}') THEN ${z} ELSE ${Z} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const T=ce(M.findField(o.fields,k));T.name=$,T.alias=$,W=new q(T,E.create(`CASE WHEN (${k}='${d}') THEN ${v} ELSE ${k} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),he=new q(new O({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${J}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let T=`${v}='@T'`,Ne=`${k}='@T'`;m!==null&&(T+=` AND ${A}=@A`,Ne+=` AND ${V}=@A`),N="(("+T+") OR ("+Ne+"))",N=ie(N,"@T",d??""),T=ie(T,"@T",d??""),m!==null&&(T=ie(T,"@A",m.toString()),N=ie(N,"@A",m.toString())),K.codefield=E.create("CASE WHEN "+T+` THEN ${z} ELSE ${Z} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const le=ce(M.findField(o.fields,k));le.name=$,le.alias=$,W=new q(le,E.create("CASE WHEN "+T+` THEN ${k} ELSE ${v} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":N=`${v}='${d}' AND ${J} = 2`,m!==null&&(N+=` AND ${A} = `+m.toString()),K.codefield=z,N="( "+N+" )",W=new re(M.findField(o.fields,k),$,$);break;case"content":N=`(${k}='${d}' AND ${J} = 2)`,m!==null&&(N+=` AND ${V} = `+m.toString()),K.codefield=Z,N="( "+N+" )",W=new re(M.findField(o.fields,v),$,$);break;case"structure":N=`(${v}='${d}' AND ${J} = 3)`,m!==null&&(N+=` AND ${A} = `+m.toString()),K.codefield=z,N="( "+N+" )",W=new re(M.findField(o.fields,k),$,be);break;case"attached":N=`(${k}='${d}' AND ${J} = 3)`,m!==null&&(N+=` AND ${V} = `+m.toString()),K.codefield=Z,N="( "+N+" )",W=new re(M.findField(o.fields,v),$,be);break;default:throw new y(n,w.InvalidParameter,r)}return D&&(N="1 <> 1"),new M({parentfeatureset:o,adaptedFields:[new me(M.findField(o.fields,Pe)),new me(M.findField(o.fields,$e)),W,he,K,ge],extraFilter:N?E.create(N,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})}))},t.signatures.push({name:"featuresetbyassociation",min:2,max:6}),t.functions.groupby=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,3,3,n,r),!L(e[0]))throw new y(n,w.InvalidParameter,r);const i=await e[0].load(),a=[],l=[];let p=!1,c=[];if(P(e[1]))c.push(e[1]);else if(e[1]instanceof G)c.push(e[1]);else if(U(e[1]))c=e[1];else{if(!_(e[1]))throw new y(n,w.InvalidParameter,r);c=e[1].toArray()}for(const u of c)if(P(u)){const o=E.create(x(u),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),d=Ae(o)===!0?x(u):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(u instanceof G))throw new y(n,w.InvalidParameter,r);{const o=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",d=u.hasField("expression")?u.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new y(n,w.InvalidParameter,r);a.push({name:o,expression:E.create(d||o,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],P(e[2]))c.push(e[2]);else if(U(e[2]))c=e[2];else if(_(e[2]))c=e[2].toArray();else{if(!(e[2]instanceof G))throw new y(n,w.InvalidParameter,r);c.push(e[2])}for(const u of c){if(!(u instanceof G))throw new y(n,w.InvalidParameter,r);{const o=u.hasField("name")?u.field("name"):"",d=u.hasField("statistic")?u.field("statistic"):"",m=u.hasField("expression")?u.field("expression"):"";if(!(o&&d&&P(d)&&m))throw new y(n,w.InvalidParameter,r);l.push({name:o,statistic:d,expression:E.create(m,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(p){const u={};for(const d of i.fields)u[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;u["field_"+o.toString()]===1;)o++;u["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const u of a)pe(u.expression,t,n);for(const u of l)pe(u.expression,t,n);return e[0].groupby(a,l)}))},t.signatures.push({name:"groupby",min:3,max:3}),t.functions.distinct=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(L(e[0])){S(e,2,2,n,r);const i=await e[0].load(),a=[];let l=[];if(P(e[1]))l.push(e[1]);else if(e[1]instanceof G)l.push(e[1]);else if(U(e[1]))l=e[1];else{if(!_(e[1]))throw new y(n,w.InvalidParameter,r);l=e[1].toArray()}let p=!1;for(const c of l)if(P(c)){const u=E.create(x(c),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),o=Ae(u)===!0?x(c):"%%%%FIELDNAME";a.push({name:o,expression:u}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(c instanceof G))throw new y(n,w.InvalidParameter,r);{const u=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",o=c.hasField("expression")?c.field("expression"):"";if(u==="%%%%FIELDNAME"&&(p=!0),!u)throw new y(n,w.InvalidParameter,r);a.push({name:u,expression:E.create(o||u,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(p){const c={};for(const o of i.fields)c[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(c[o.name.toLowerCase()]=1);let u=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;c["field_"+u.toString()]===1;)u++;c["field_"+u.toString()]=1,o.name="FIELD_"+u.toString()}}for(const c of a)pe(c.expression,t,n);return e[0].groupby(a,[])}return gt(e)}))},t.functions.getfeaturesetinfo=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,1,1,n,r),!L(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?G.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(n),!1,!1):null}))},t.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),t.functions.filterbysubtypecode=function(n,r){return t.standardFunctionAsync(n,r,(async(g,h,e)=>{if(S(e,2,2,n,r),L(e[0])){const i=await e[0].load(),a=e[1];if(!Ke(a))throw new y(n,w.InvalidParameter,r);if(i.subtypeField){const p=E.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new fe({parentfeatureset:e[0],whereclause:p})}if(i.typeIdField===null||i.typeIdField==="")throw new y(n,w.FeatureSetDoesNotHaveSubtypes,r);const l=E.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new fe({parentfeatureset:e[0],whereclause:l})}throw new y(n,w.InvalidParameter,r)}))},t.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{Gt as registerFunctions};
