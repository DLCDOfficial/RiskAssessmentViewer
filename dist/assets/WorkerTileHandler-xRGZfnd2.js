import{jG as ot,hX as lt,aH as Ft,fU as vt,bn as Bt}from"./index-DzoQLc5A.js";import{l as Ie,m as O,c as Pe,t as H,a as Te,E as je,b as ct,n as Je,U as Ct,O as Ut,p as Et,u as Xe,i as ge,I as Be,o as Ot}from"./StyleRepository-DJleUG8Z.js";import{h as C,s as st,o as Me,r as _e,a as ht,f as Mt,e as ut,i as $t,c as he,p as Ee,d as Nt,g as zt,_ as Gt}from"./GeometryUtils-DF5xixq3.js";import{t as ft,a as Ht,c as Kt,i as jt}from"./libtess-BQuW8DDB.js";import{a as Wt}from"./pbf-B-Qb_RCl.js";import{e as dt}from"./earcut-D9gy186-.js";import"https://js.arcgis.com/map-components/4.33/arcgis-map-components.esm.js";import"./enums-CIq3dAOf.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./colorUtils-DpzmtTt4.js";import"./memoryEstimations-Cau39Oyv.js";const Oe=[["(",")"],[")","("],["<",">"],[">","<"],["[","]"],["]","["],["{","}"],["}","{"],["«","»"],["»","«"],["‹","›"],["›","‹"],["⁽","⁾"],["⁾","⁽"],["₍","₎"],["₎","₍"],["≤","≥"],["≥","≤"],["〈","〉"],["〉","〈"],["﹙","﹚"],["﹚","﹙"],["﹛","﹜"],["﹜","﹛"],["﹝","﹞"],["﹞","﹝"],["﹤","﹥"],["﹥","﹤"]],Ae=["آ","أ","إ","ا"],qt=["ﻵ","ﻷ","ﻹ","ﻻ"],Yt=["ﻶ","ﻸ","ﻺ","ﻼ"],Ge=["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ی","ئ","ؤ"],Zt=["ﺍ","ﺏ","ﺕ","ﺙ","ﺝ","ﺡ","ﺥ","ﺩ","ﺫ","ﺭ","ﺯ","ﺱ","ﺵ","ﺹ","ﺽ","ﻁ","ﻅ","ﻉ","ﻍ","ﻑ","ﻕ","ﻙ","ﻝ","ﻡ","ﻥ","ﻩ","ﻭ","ﻱ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯼ","ﺉ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺉ","ﺅ"],Jt=["ﺎ","ﺐ","ﺖ","ﺚ","ﺞ","ﺢ","ﺦ","ﺪ","ﺬ","ﺮ","ﺰ","ﺲ","ﺶ","ﺺ","ﺾ","ﻂ","ﻆ","ﻊ","ﻎ","ﻒ","ﻖ","ﻚ","ﻞ","ﻢ","ﻦ","ﻪ","ﻮ","ﻲ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯽ","ﺊ","ﺆ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺊ","ﺆ"],Xt=["ﺎ","ﺒ","ﺘ","ﺜ","ﺠ","ﺤ","ﺨ","ﺪ","ﺬ","ﺮ","ﺰ","ﺴ","ﺸ","ﺼ","ﻀ","ﻄ","ﻈ","ﻌ","ﻐ","ﻔ","ﻘ","ﻜ","ﻠ","ﻤ","ﻨ","ﻬ","ﻮ","ﻴ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯿ","ﺌ","ﺆ","ﹱ","ﹲ","ﹴ","ﹷ","ﹹ","ﹻ","ﹽ","ﹿ","ﺀ","ﺌ","ﺆ"],Qt=["ﺍ","ﺑ","ﺗ","ﺛ","ﺟ","ﺣ","ﺧ","ﺩ","ﺫ","ﺭ","ﺯ","ﺳ","ﺷ","ﺻ","ﺿ","ﻃ","ﻇ","ﻋ","ﻏ","ﻓ","ﻗ","ﻛ","ﻟ","ﻣ","ﻧ","ﻫ","ﻭ","ﻳ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯾ","ﺋ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺋ","ﺅ"],xt=["ء","آ","أ","ؤ","إ","ا","ة","د","ذ","ر","ز","و","ى"],es=["ً","ً","ٌ","؟","ٍ","؟","َ","َ","ُ","ُ","ِ","ِ","ّ","ّ","ْ","ْ","ء","آ","آ","أ","أ","ؤ","ؤ","إ","إ","ئ","ئ","ئ","ئ","ا","ا","ب","ب","ب","ب","ة","ة","ت","ت","ت","ت","ث","ث","ث","ث","ج","ج","ج","ج","ح","ح","ح","ح","خ","خ","خ","خ","د","د","ذ","ذ","ر","ر","ز","ز","س","س","س","س","ش","ش","ش","ش","ص","ص","ص","ص","ض","ض","ض","ض","ط","ط","ط","ط","ظ","ظ","ظ","ظ","ع","ع","ع","ع","غ","غ","غ","غ","ف","ف","ف","ف","ق","ق","ق","ق","ك","ك","ك","ك","ل","ل","ل","ل","م","م","م","م","ن","ن","ن","ن","ه","ه","ه","ه","و","و","ى","ى","ي","ي","ي","ي","ﻵ","ﻶ","ﻷ","ﻸ","ﻹ","ﻺ","ﻻ","ﻼ","؟","؟","؟"],yt=["ء","ف"],ts=["غ","ي"],ss=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],rs=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],i=0,L=1,k=2,z=3,e=4,ne=5,ze=6,t=7,W=8,Y=9,se=10,F=11,x=12,is=13,ns=14,as=15,os=16,ls=17,D=18,cs=["UBAT_L","UBAT_R","UBAT_EN","UBAT_AN","UBAT_ON","UBAT_B","UBAT_S","UBAT_AL","UBAT_WS","UBAT_CS","UBAT_ES","UBAT_ET","UBAT_NSM","UBAT_LRE","UBAT_RLE","UBAT_PDF","UBAT_LRO","UBAT_RLO","UBAT_BN"],ie=100,hs=[ie+0,i,i,i,i,ie+1,ie+2,ie+3,L,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,ie+4,e,e,e,i,e,i,e,i,e,e,e,i,i,e,e,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,e,e,i,i,e,e,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,ie+5,t,t,ie+6,ie+7],us=[[D,D,D,D,D,D,D,D,D,ze,ne,ze,W,ne,D,D,D,D,D,D,D,D,D,D,D,D,D,D,ne,ne,ne,ze,W,e,e,F,F,F,e,e,e,e,e,se,Y,se,Y,Y,k,k,k,k,k,k,k,k,k,k,Y,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,D,D,D,D,D,D,ne,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,Y,e,F,F,F,F,e,e,e,e,i,e,e,D,e,e,F,F,k,k,e,i,e,e,e,k,i,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i],[i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,e,e,e,e,e,e,e,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,L,x,L,x,x,L,x,x,L,x,e,e,e,e,e,e,e,e,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,e,e,e,e,e,L,L,L,L,L,e,e,e,e,e,e,e,e,e,e,e],[z,z,z,z,e,e,e,e,t,F,F,t,Y,t,e,e,x,x,x,x,x,x,x,x,x,x,x,t,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,z,z,z,z,z,z,z,z,z,z,F,z,z,t,t,t,x,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,z,e,x,x,x,x,x,x,t,t,x,x,e,x,x,x,x,t,t,k,k,k,k,k,k,k,k,k,k,t,t,t,t,t,t],[t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,t,t,x,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,x,x,x,x,x,x,x,x,x,L,L,e,e,e,e,L,e,e,e,e,e],[W,W,W,W,W,W,W,W,W,W,W,D,D,D,i,L,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,W,ne,is,ns,as,os,ls,Y,F,F,F,F,F,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,Y,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,W,D,D,D,D,D,e,e,e,e,e,D,D,D,D,D,D,k,i,e,e,k,k,k,k,k,k,se,se,e,e,e,i,k,k,k,k,k,k,k,k,k,k,se,se,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],[i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,e,e,e,e,e,L,x,L,L,L,L,L,L,L,L,L,L,se,L,L,L,L,L,L,L,L,L,L,L,L,L,e,L,L,L,L,L,e,L,e,L,L,e,L,L,e,L,L,L,L,L,L,L,L,L,L,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],[x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,Y,e,Y,e,e,Y,e,e,e,e,e,e,e,e,e,F,e,e,se,se,e,e,e,e,e,F,F,e,e,e,e,e,t,t,t,t,t,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,e,D],[e,e,e,F,F,F,e,e,e,e,e,se,Y,se,Y,Y,k,k,k,k,k,k,k,k,k,k,Y,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,i,i,i,i,i,i,e,e,i,i,i,i,i,i,e,e,i,i,i,i,i,i,e,e,i,i,i,e,e,e,F,F,e,e,e,F,F,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]];class fs{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(s,r,a){if(this.sourceToTarget=[],this.targetToSource=[],!s)return"";if(Ds(this.sourceToTarget,this.targetToSource,s.length),!this.checkParameters(r,a))return s;r=this.inputFormat,a=this.outputFormat;let n=s;const o=Ss,c=mt(r.charAt(1)),h=mt(a.charAt(1)),u=(r.charAt(0)==="I"?"L":r.charAt(0))+c,f=(a.charAt(0)==="I"?"L":a.charAt(0))+h,d=r.charAt(2)+a.charAt(2);o.defInFormat=u,o.defOutFormat=f,o.defSwap=d;const p=De(s,u,f,d,o);let g=!1;return a.charAt(1)==="R"?g=!0:a.charAt(1)!=="C"&&a.charAt(1)!=="D"||(g=this.checkContextual(p)==="rtl"),this.sourceToTarget=Q,this.targetToSource=Vs(this.sourceToTarget),Ke=this.targetToSource,n=r.charAt(3)===a.charAt(3)?p:a.charAt(3)==="S"?xs(g,p):ps(p,g,!0),this.sourceToTarget=Q,this.targetToSource=Ke,this.levels=We,n}_inputFormatSetter(s){if(!_t.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=s}_outputFormatSetter(s){if(!_t.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=s}checkParameters(s,r){return s?this._inputFormatSetter(s):s=this.inputFormat,r?this._outputFormatSetter(r):r=this.outputFormat,s!==r}checkContextual(s){let r=He(s);if(r!=="ltr"&&r!=="rtl"){try{r=document.dir.toLowerCase()}catch{}r!=="ltr"&&r!=="rtl"&&(r="ltr")}return r}hasBidiChar(s){return Fs.test(s)}}function De(l,s,r,a,n){const o=ds(l,{inFormat:s,outFormat:r,swap:a},n);if(o.inFormat===o.outFormat)return l;s=o.inFormat,r=o.outFormat,a=o.swap;const c=s.slice(0,1),h=s.slice(1,4),u=r.slice(0,1),f=r.slice(1,4);if(n.inFormat=s,n.outFormat=r,n.swap=a,c==="L"&&r==="VLTR"){if(h==="LTR")return n.dir=pe,ue(l,n);if(h==="RTL")return n.dir=Ve,ue(l,n)}if(c==="V"&&u==="V")return n.dir=h==="RTL"?Ve:pe,Qe(l,n);if(c==="L"&&r==="VRTL")return h==="LTR"?(n.dir=pe,l=ue(l,n)):(n.dir=Ve,l=ue(l,n)),Qe(l);if(s==="VLTR"&&r==="LLTR")return n.dir=pe,ue(l,n);if(c==="V"&&u==="L"&&h!==f)return l=Qe(l),h==="RTL"?De(l,"LLTR","VLTR",a,n):De(l,"LRTL","VRTL",a,n);if(s==="VRTL"&&r==="LRTL")return De(l,"LRTL","VRTL",a,n);if(c==="L"&&u==="L"){const d=n.swap;return n.swap=d.slice(0,1)+"N",h==="RTL"?(n.dir=Ve,l=ue(l,n),n.swap="N"+d.slice(1,3),n.dir=pe,l=ue(l,n)):(n.dir=pe,l=ue(l,n),n.swap="N"+d.slice(1,3),l=De(l,"VLTR","LRTL",n.swap,n)),l}return l}function ds(l,s,r){if(s.inFormat===void 0&&(s.inFormat=r.defInFormat),s.outFormat===void 0&&(s.outFormat=r.defOutFormat),s.swap===void 0&&(s.swap=r.defSwap),s.inFormat===s.outFormat)return s;const a=s.inFormat.slice(0,1),n=s.outFormat.slice(0,1);let o,c=s.inFormat.slice(1,4),h=s.outFormat.slice(1,4);return c.charAt(0)==="C"&&(o=He(l),c=o==="ltr"||o==="rtl"?o.toUpperCase():s.inFormat.charAt(2)==="L"?"LTR":"RTL",s.inFormat=a+c),h.charAt(0)==="C"&&(o=He(l),o==="rtl"?h="RTL":o==="ltr"?(o=gs(l),h=o.toUpperCase()):h=s.outFormat.charAt(2)==="L"?"LTR":"RTL",s.outFormat=n+h),s}function xs(l,s,r){if(s.length===0)return"";l===void 0&&(l=!0);const a=(s=String(s)).split("");let n=0,o=1,c=a.length;l||(n=a.length-1,o=-1,c=1);const h=ys(a,n,o,c);let u="";for(let f=0;f<a.length;f++)Ts(h,h.length,f)>-1?(Vt(Ke,f,!l,-1),Q.splice(f,1)):u+=a[f];return u}function ys(l,s,r,a,n){let o=0;const c=[];let h=0;for(let u=s;u*r<a;u+=r)if(Dt(l[u])||Se(l[u])){if(l[u]==="ل"&&Ls(l,u+r,r,a)){l[u]=Ps(l[u+r],o===0?qt:Yt),u+=r,Ms(l,u,r,a),c[h]=u,h++,o=0;continue}const f=l[u];o===1?l[u]=gt(l,u+r,r,a)?Bs(l[u]):et(l[u],Jt):gt(l,u+r,r,a)===!0?l[u]=et(l[u],Qt):l[u]=et(l[u],Zt),Se(f)||(o=1),ws(f)===!0&&(o=0)}else o=0;return c}function He(l){const s=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(l);return s?s[0]<="z"?"ltr":"rtl":""}function gs(l){const s=l.split("");return s.reverse(),He(s.join(""))}function ps(l,s,r){if(l.length===0)return"";s===void 0&&(s=!0);let a="";const n=(l=String(l)).split("");for(let o=0;o<l.length;o++){let c=!1;if(n[o]>="ﹰ"&&n[o]<"\uFEFF"){const h=l.charCodeAt(o);n[o]>="ﻵ"&&n[o]<="ﻼ"?(s?(o>0&&r&&n[o-1]===" "?a=a.slice(0,-1)+"ل":(a+="ل",c=!0),a+=Ae[(h-65269)/2]):(a+=Ae[(h-65269)/2],a+="ل",o+1<l.length&&r&&n[o+1]===" "?o++:c=!0),c&&(Vt(Ke,o,!0,1),Q.splice(o,0,Q[o]))):a+=es[h-65136]}else a+=n[o]}return a}function ue(l,s){const r=l.split(""),a=[];return Pt(r,a,s),_s(r,a,s),pt(2,r,a,s),pt(1,r,a,s),We=a,r.join("")}function Pt(l,s,r){const a=l.length,n=r.dir?rs:ss;let o=0,c=-1;const h=[],u=[];r.hiLevel=r.dir,r.lastArabic=!1,r.hasUbatAl=!1,r.hasUbatB=!1,r.hasUbatS=!1;for(let f=0;f<a;f++)h[f]=Is(l[f]);for(let f=0;f<a;f++){const d=o,p=As(l,h,u,f,r);u[f]=p,o=n[d][p];const g=240&o;o&=15;const y=n[o][ks];if(s[f]=y,g>0)if(g===16){for(let m=c;m<f;m++)s[m]=1;c=-1}else c=-1;if(n[o][Rs])c===-1&&(c=f);else if(c>-1){for(let m=c;m<f;m++)s[m]=y;c=-1}h[f]===ne&&(s[f]=0),r.hiLevel|=y}r.hasUbatS&&ms(h,s,a,r)}function ms(l,s,r,a){for(let n=0;n<r;n++)if(l[n]===ze){s[n]=a.dir;for(let o=n-1;o>=0&&l[o]===W;o--)s[o]=a.dir}}function _s(l,s,r){if(r.hiLevel!==0&&r.swap[0]!==r.swap[1])for(let a=0;a<l.length;a++)s[a]===1&&(l[a]=bs(l[a]))}function Is(l){const s=l.charCodeAt(0),r=hs[s>>8];return r<ie?r:us[r-ie][255&s]}function Qe(l,s){const r=l.split("");if(s){const a=[];Pt(r,a,s),We=a}return r.reverse(),Q.reverse(),r.join("")}function Ts(l,s,r){for(let a=0;a<s;a++)if(l[a]===r)return a;return-1}function Dt(l){for(let s=0;s<yt.length;s++)if(l>=yt[s]&&l<=ts[s])return!0;return!1}function gt(l,s,r,a){for(;s*r<a&&Se(l[s]);)s+=r;return!!(s*r<a&&Dt(l[s]))}function Ls(l,s,r,a){for(;s*r<a&&Se(l[s]);)s+=r;let n=" ";if(!(s*r<a))return!1;n=l[s];for(let o=0;o<Ae.length;o++)if(Ae[o]===n)return!0;return!1}function pt(l,s,r,a){if(a.hiLevel<l)return;if(l===1&&a.dir===Ve&&!a.hasUbatB)return s.reverse(),void Q.reverse();const n=s.length;let o,c,h,u,f,d=0;for(;d<n;){if(r[d]>=l){for(o=d+1;o<n&&r[o]>=l;)o++;for(c=d,h=o-1;c<h;c++,h--)u=s[c],s[c]=s[h],s[h]=u,f=Q[c],Q[c]=Q[h],Q[h]=f;d=o}d++}}function As(l,s,r,a,n){const o=s[a];return{UBAT_L:()=>(n.lastArabic=!1,i),UBAT_R:()=>(n.lastArabic=!1,L),UBAT_ON:()=>e,UBAT_AN:()=>z,UBAT_EN:()=>n.lastArabic?z:k,UBAT_AL:()=>(n.lastArabic=!0,n.hasUbatAl=!0,L),UBAT_WS:()=>e,UBAT_CS:()=>{let c,h;return a<1||a+1>=s.length||(c=r[a-1])!==k&&c!==z||(h=s[a+1])!==k&&h!==z?e:(n.lastArabic&&(h=z),h===c?h:e)},UBAT_ES:()=>(a>0?r[a-1]:ne)===k&&a+1<s.length&&s[a+1]===k?k:e,UBAT_ET:()=>{if(a>0&&r[a-1]===k)return k;if(n.lastArabic)return e;let c=a+1;const h=s.length;for(;c<h&&s[c]===F;)c++;return c<h&&s[c]===k?k:e},UBAT_NSM:()=>{if(n.inFormat==="VLTR"){const c=s.length;let h=a+1;for(;h<c&&s[h]===x;)h++;if(h<c){const u=l[a].charCodeAt(0),f=u>=1425&&u<=2303||u===64286,d=s[h];if(f&&(d===L||d===t))return L}}return a<1||s[a-1]===ne?e:r[a-1]},UBAT_B:()=>(n.lastArabic=!0,n.hasUbatB=!0,n.dir),UBAT_S:()=>(n.hasUbatS=!0,e),UBAT_LRE:()=>(n.lastArabic=!1,e),UBAT_RLE:()=>(n.lastArabic=!1,e),UBAT_LRO:()=>(n.lastArabic=!1,e),UBAT_RLO:()=>(n.lastArabic=!1,e),UBAT_PDF:()=>(n.lastArabic=!1,e),UBAT_BN:()=>e}[cs[o]]()}function bs(l){let s,r=0,a=Oe.length-1;for(;r<=a;)if(s=Math.floor((r+a)/2),l<Oe[s][0])a=s-1;else{if(!(l>Oe[s][0]))return Oe[s][1];r=s+1}return l}function ws(l){for(let s=0;s<xt.length;s++)if(xt[s]===l)return!0;return!1}function Bs(l){for(let s=0;s<Ge.length;s++)if(l===Ge[s])return Xt[s];return l}function et(l,s){for(let r=0;r<Ge.length;r++)if(l===Ge[r])return s[r];return l}function Se(l){return l>="ً"&&l<="ٕ"}function mt(l){return l==="L"?"LTR":l==="R"?"RTL":l==="C"?"CLR":l==="D"?"CRL":""}function Ms(l,s,r,a){for(;s*r<a&&Se(l[s]);)s+=r;return s*r<a&&(l[s]=" ",!0)}function Ps(l,s){for(let r=0;r<Ae.length;r++)if(l===Ae[r])return s[r];return l}function Ds(l,s,r){Q=[],We=[];for(let a=0;a<r;a++)l[a]=a,s[a]=a,Q[a]=a}function Vs(l){const s=new Array(l.length);for(let r=0;r<l.length;r++)s[l[r]]=r;return s}function Vt(l,s,r,a){for(let n=0;n<l.length;n++)(l[n]>s||!r&&l[n]===s)&&(l[n]+=a)}let Q=[],Ke=[],We=[];const Ss={dir:0,defInFormat:"LLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,defOutFormat:""},ks=5,Rs=6,pe=0,Ve=1,_t=/^[(I|V)][(L|R|C|D)][(Y|N)][(S|N)][N]$/,Fs=/[\u0591-\u06ff\ufb1d-\ufefc]/;function vs(l){return l===746||l===747||!(l<4352)&&(l>=12704&&l<=12735||l>=12544&&l<=12591||l>=65072&&l<=65103&&!(l>=65097&&l<=65103)||l>=63744&&l<=64255||l>=13056&&l<=13311||l>=11904&&l<=12031||l>=12736&&l<=12783||l>=12288&&l<=12351&&!(l>=12296&&l<=12305||l>=12308&&l<=12319||l===12336)||l>=13312&&l<=19903||l>=19968&&l<=40959||l>=12800&&l<=13055||l>=12592&&l<=12687||l>=43360&&l<=43391||l>=55216&&l<=55295||l>=4352&&l<=4607||l>=44032&&l<=55215||l>=12352&&l<=12447||l>=12272&&l<=12287||l>=12688&&l<=12703||l>=12032&&l<=12255||l>=12784&&l<=12799||l>=12448&&l<=12543&&l!==12540||l>=65280&&l<=65519&&!(l===65288||l===65289||l===65293||l>=65306&&l<=65310||l===65339||l===65341||l===65343||l>=65371&&l<=65503||l===65507||l>=65512&&l<=65519)||l>=65104&&l<=65135&&!(l>=65112&&l<=65118||l>=65123&&l<=65126)||l>=5120&&l<=5759||l>=6320&&l<=6399||l>=65040&&l<=65055||l>=19904&&l<=19967||l>=40960&&l<=42127||l>=42128&&l<=42191)}function Cs(l){return!(l<11904)&&(l>=12704&&l<=12735||l>=12544&&l<=12591||l>=65072&&l<=65103||l>=63744&&l<=64255||l>=13056&&l<=13311||l>=11904&&l<=12031||l>=12736&&l<=12783||l>=12288&&l<=12351||l>=13312&&l<=19903||l>=19968&&l<=40959||l>=12800&&l<=13055||l>=65280&&l<=65519||l>=12352&&l<=12447||l>=12272&&l<=12287||l>=12032&&l<=12255||l>=12784&&l<=12799||l>=12448&&l<=12543||l>=65040&&l<=65055||l>=42128&&l<=42191||l>=40960&&l<=42127)}function Us(l){switch(l){case 10:case 32:case 38:case 40:case 41:case 43:case 45:case 47:case 173:case 183:case 8203:case 8208:case 8211:case 8231:return!0}return!1}function It(l){switch(l){case 9:case 10:case 11:case 12:case 13:case 32:return!0}return!1}const ae=24,St=17;let kt=class{constructor(s,r,a,n,o,c,h){this._glyphItems=s,this._maxWidth=r,this._lineHeight=a,this._letterSpacing=n,this._hAnchor=o,this._vAnchor=c,this._justify=h}getShaping(s,r,a){const n=this._letterSpacing,o=this._lineHeight,c=this._justify,h=this._maxWidth,u=[];let f=0,d=0;for(const I of s){const w=I.codePointAt(0);if(w==null)continue;const P=a&&vs(w);let A;for(const M of this._glyphItems)if(A=M[w],A)break;u.push({codePoint:w,x:f,y:d,vertical:P,glyphMosaicItem:A}),A&&(f+=A.metrics.advance+n)}let p=f;h>0&&(p=f/Math.max(1,Math.ceil(f/h)));const g=s.includes("​"),y=[],m=u.length;for(let I=0;I<m-1;I++){const w=u[I].codePoint,P=Cs(w);if(Us(w)||P){let A=0;if(w===10)A-=1e4;else if(P&&g)A+=150;else{w!==40&&w!==65288||(A+=50);const M=u[I+1].codePoint;M!==41&&M!==65289||(A+=50)}y.push(this._buildBreak(I+1,u[I].x,p,y,A,!1))}}const T=this._optimalBreaks(this._buildBreak(m,f,p,y,0,!0));let B=0;const _=r?-o:o;let b=0;for(let I=0;I<T.length;I++){const w=T[I];let P=b;for(;P<w&&It(u[P].codePoint);)u[P].glyphMosaicItem=null,++P;let A=w-1;for(;A>P&&It(u[A].codePoint);)u[A].glyphMosaicItem=null,--A;if(P<=A){const M=u[P].x;for(let S=P;S<=A;S++)u[S].x-=M,u[S].y=d;let R=u[A].x;u[A].glyphMosaicItem&&(R+=u[A].glyphMosaicItem.metrics.advance),B=Math.max(R,B),c&&this._applyJustification(u,P,A)}b=w,d+=_}if(u.length>0){const I=T.length-1,w=(c-this._hAnchor)*B;let P=(-this._vAnchor*(I+1)+.5)*o;r&&I&&(P+=I*o);for(const A of u)A.x+=w,A.y+=P}return u.filter((I=>I.glyphMosaicItem))}static getTextBox(s,r){if(!s.length)return null;let a=1/0,n=1/0,o=0,c=0;for(const h of s){const u=h.glyphMosaicItem.metrics.advance,f=h.x,d=h.y-St,p=f+u,g=d+r;a=Math.min(a,f),o=Math.max(o,p),n=Math.min(n,d),c=Math.max(c,g)}return{x:a,y:n,width:o-a,height:c-n}}static getBox(s){if(!s.length)return null;let r=1/0,a=1/0,n=0,o=0;for(const c of s){const{height:h,left:u,top:f,width:d}=c.glyphMosaicItem.metrics,p=c.x,g=c.y-(h-Math.abs(f)),y=p+d+u,m=g+h;r=Math.min(r,p),n=Math.max(n,y),a=Math.min(a,g),o=Math.max(o,m)}return{x:r,y:a,width:n-r,height:o-a}}static addDecoration(s,r){const a=s.length;if(a===0)return;const n=3;let o=s[0].x+s[0].glyphMosaicItem.metrics.left,c=s[0].y;for(let u=1;u<a;u++){const f=s[u];if(f.y!==c){const d=s[u-1].x+s[u-1].glyphMosaicItem.metrics.left+s[u-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:c+r-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new ft(4,0,4,8),metrics:{width:d-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}}),c=f.y,o=f.x+f.glyphMosaicItem.metrics.left}}const h=s[a-1].x+s[a-1].glyphMosaicItem.metrics.left+s[a-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:c+r-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new ft(4,0,4,8),metrics:{width:h-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}})}_breakScore(s,r,a,n){const o=(s-r)*(s-r);return n?s<r?o/2:2*o:o+Math.abs(a)*a}_buildBreak(s,r,a,n,o,c){let h=null,u=this._breakScore(r,a,o,c);for(const f of n){const d=r-f.x,p=this._breakScore(d,a,o,c)+f.score;p<=u&&(h=f,u=p)}return{index:s,x:r,score:u,previousBreak:h}}_optimalBreaks(s){return s?this._optimalBreaks(s.previousBreak).concat(s.index):[]}_applyJustification(s,r,a){const n=s[a],o=n.vertical?ae:n.glyphMosaicItem?n.glyphMosaicItem.metrics.advance:0,c=(n.x+o)*this._justify;for(let h=r;h<=a;h++)s[h].x-=c}};const Tt=!0,ye=.5,tt=2;class $e{constructor(s,r,a=0,n=-1,o=ye){this.x=s,this.y=r,this.angle=a,this.segment=n,this.minzoom=o}}class Ne{constructor(s,r,a,n,o,c=ye,h=_e){this.anchor=s,this.labelAngle=r,this.glyphAngle=a,this.page=n,this.alternateVerticalGlyph=o,this.minzoom=c,this.maxzoom=h}}class Lt{constructor(s,r,a,n,o,c,h,u,f,d,p,g){this.tl=s,this.tr=r,this.bl=a,this.br=n,this.mosaicRect=o,this.labelAngle=c,this.minAngle=h,this.maxAngle=u,this.anchor=f,this.minzoom=d,this.maxzoom=p,this.page=g}}class At{constructor(s){this.shapes=s}}let Es=class{getIconPlacement(s,r,a){const n=new C(s.x,s.y),o=a.rotationAlignment===Ie.MAP,c=a.keepUpright;let h=a.rotate*st;o&&(h+=s.angle);const u=new At([]);return a.allowOverlap&&a.ignorePlacement||!Tt||(u.iconColliders=[]),this._addIconPlacement(u,n,r,a,h),o&&c&&this._addIconPlacement(u,n,r,a,h+Me),u}_addIconPlacement(s,r,a,n,o){const c=a.rasterizationScale,h=a.width/c,u=a.height/c,f=n.offset;let d=f[0],p=f[1];switch(n.anchor){case O.CENTER:d-=h/2,p-=u/2;break;case O.LEFT:p-=u/2;break;case O.RIGHT:d-=h,p-=u/2;break;case O.TOP:d-=h/2;break;case O.BOTTOM:d-=h/2,p-=u;break;case O.TOP_LEFT:break;case O.BOTTOM_LEFT:p-=u;break;case O.TOP_RIGHT:d-=h;break;case O.BOTTOM_RIGHT:d-=h,p-=u}const g=a.rect,y=2/c,m=d-y,T=p-y,B=m+g.width/c,_=T+g.height/c,b=new C(m,T),I=new C(B,_),w=new C(m,_),P=new C(B,T);if(o!==0){const M=Math.cos(o),R=Math.sin(o);b.rotate(M,R),I.rotate(M,R),w.rotate(M,R),P.rotate(M,R)}const A=new Lt(b,P,w,I,g,o,0,256,r,ye,_e,0);if(s.shapes.push(A),(!n.allowOverlap||!n.ignorePlacement)&&Tt){const M=n.size,R=n.padding,S={xTile:r.x,yTile:r.y,dxPixels:d*M-R,dyPixels:p*M-R,hard:!n.optional,partIndex:0,width:h*M+2*R,height:u*M+2*R,angle:o,minLod:ye,maxLod:_e};s.iconColliders.push(S)}}getTextPlacement(s,r,a,n){const o=new C(s.x,s.y),c=n.rotate*st,h=n.rotationAlignment===Ie.MAP,u=n.keepUpright,f=n.padding;let d=ye;const p=h?s.angle:0,g=s.segment>=0&&h,y=n.allowOverlap&&n.ignorePlacement?null:[],m=[],T=4,B=!g;let _=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,I=_,w=b;const P=(g||h)&&u,A=n.size/ae;let M=!1;for(const V of r)if(V.vertical){M=!0;break}let R,S=0,v=0;if(!g&&M){const V=kt.getTextBox(r,n.lineHeight*ae);switch(n.anchor){case O.LEFT:S=V.height/2,v=-V.width/2;break;case O.RIGHT:S=-V.height/2,v=V.width/2;break;case O.TOP:S=V.height/2,v=V.width/2;break;case O.BOTTOM:S=-V.height/2,v=-V.width/2;break;case O.TOP_LEFT:S=V.height;break;case O.BOTTOM_LEFT:v=-V.width;break;case O.TOP_RIGHT:v=V.width;break;case O.BOTTOM_RIGHT:S=-V.height}}S+=n.offset[0]*ae,v+=n.offset[1]*ae;for(const V of r){const N=V.glyphMosaicItem;if(!N||N.rect.isEmpty)continue;const E=N.rect,$=N.metrics,K=N.page;if(y&&B){if(R!==void 0&&R!==V.y){let G,q,Z,J;M?(G=-w+S,q=_+v,Z=w-I,J=b-_):(G=_+S,q=I+v,Z=b-_,J=w-I);const ee={xTile:s.x,yTile:s.y,dxPixels:G*A-f,dyPixels:q*A-f,hard:!n.optional,partIndex:1,width:Z*A+2*f,height:J*A+2*f,angle:c,minLod:ye,maxLod:_e};y.push(ee),_=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,I=_,w=b}R=V.y}const fe=[];if(g){const G=.5*N.metrics.width,q=(V.x+$.left-T+G)*A*Pe;if(d=this._placeGlyph(s,d,q,a,s.segment,1,V.vertical,K,fe),u&&(d=this._placeGlyph(s,d,q,a,s.segment,-1,V.vertical,K,fe)),d>=tt)break}else fe.push(new Ne(o,p,p,K,!1)),h&&u&&fe.push(new Ne(o,p+Me,p+Me,K,!1));const te=V.x+$.left,le=V.y-St-$.top,de=te+$.width,Ye=le+$.height;let j,re,ke,Re,xe,Fe,nt,at;if(!g&&M)if(V.vertical){const G=(te+de)/2-$.height/2,q=(le+Ye)/2+$.width/2;j=new C(-q-T+S,G-T+v),re=new C(j.x+E.width,j.y+E.height),ke=new C(j.x,re.y),Re=new C(re.x,j.y)}else j=new C(-le+T+S,te-T+v),re=new C(j.x-E.height,j.y+E.width),ke=new C(re.x,j.y),Re=new C(j.x,re.y);else j=new C(te-T+S,le-T+v),re=new C(j.x+E.width,j.y+E.height),ke=new C(j.x,re.y),Re=new C(re.x,j.y);for(const G of fe){let q,Z,J,ee;if(G.alternateVerticalGlyph){if(!xe){const ce=(le+Ye)/2+v;xe=new C((te+de)/2+S-$.height/2-T,ce+$.width/2+T),Fe=new C(xe.x+E.height,xe.y-E.width),nt=new C(Fe.x,xe.y),at=new C(xe.x,Fe.y)}q=xe,Z=nt,J=at,ee=Fe}else q=j,Z=ke,J=Re,ee=re;const ve=le,Ze=Ye,Ce=G.glyphAngle+c;if(Ce!==0){const ce=Math.cos(Ce),Ue=Math.sin(Ce);q=q.clone(),Z=Z==null?void 0:Z.clone(),J=J==null?void 0:J.clone(),ee=ee==null?void 0:ee.clone(),q.rotate(ce,Ue),ee==null||ee.rotate(ce,Ue),Z==null||Z.rotate(ce,Ue),J==null||J.rotate(ce,Ue)}let be=0,we=256;if(g&&M?V.vertical?G.alternateVerticalGlyph?(be=32,we=96):(be=224,we=32):(be=224,we=96):(be=192,we=64),m.push(new Lt(q,J,Z,ee,E,G.labelAngle,be,we,G.anchor,G.minzoom,G.maxzoom,G.page)),y&&(!P||this._legible(G.labelAngle))){if(B)te<_&&(_=te),ve<I&&(I=ve),de>b&&(b=de),Ze>w&&(w=Ze);else if(G.minzoom<tt){const ce={xTile:s.x,yTile:s.y,dxPixels:(te+S)*A-f,dyPixels:(ve+S)*A-f,hard:!n.optional,partIndex:1,width:(de-te)*A+2*f,height:(Ze-ve)*A+2*f,angle:Ce,minLod:G.minzoom,maxLod:G.maxzoom};y.push(ce)}}}}if(d>=tt)return null;if(y&&B){let V,N,E,$;M?(V=-w+S,N=_+v,E=w-I,$=b-_):(V=_+S,N=I+v,E=b-_,$=w-I);const K={xTile:s.x,yTile:s.y,dxPixels:V*A-f,dyPixels:N*A-f,hard:!n.optional,partIndex:1,width:E*A+2*f,height:$*A+2*f,angle:c,minLod:ye,maxLod:_e};y.push(K)}const U=new At(m);return y&&y.length>0&&(U.textColliders=y),U}_legible(s){const r=Mt(s);return r<65||r>=193}_placeGlyph(s,r,a,n,o,c,h,u,f){let d=c;const p=d<0?ht(s.angle+Me,ut):s.angle;let g=0;a<0&&(d*=-1,a*=-1,g=Me),d>0&&++o;let y=new C(s.x,s.y),m=n[o],T=_e;if(n.length<=o)return T;for(;;){const B=m.x-y.x,_=m.y-y.y,b=Math.sqrt(B*B+_*_),I=Math.max(a/b,r),w=B/b,P=_/b,A=ht(Math.atan2(P,w)+g,ut);if(f.push(new Ne(y,p,A,u,!1,I,T)),h&&f.push(new Ne(y,p,A,u,!0,I,T)),I<=r)return I;y=m.clone();do{if(o+=d,n.length<=o||o<0)return I;m=n[o]}while(y.isEqual(m));let M=m.x-y.x,R=m.y-y.y;const S=Math.sqrt(M*M+R*R);M*=b/S,R*=b/S,y.x-=M,y.y-=R,T=I}}};var Le;(function(l){l[l.moveTo=1]="moveTo",l[l.lineTo=2]="lineTo",l[l.close=7]="close"})(Le||(Le={}));let Os=class{constructor(s,r,a=0){this.values={},this._geometry=void 0,this._pbfGeometry=null,this.featureIndex=a;const n=r.keys,o=r.values,c=s.asUnsafe();for(;c.next();)switch(c.tag()){case 1:this.id=c.getUInt64();break;case 2:{const h=c.getMessage().asUnsafe(),u=this.values;for(;!h.empty();){const f=h.getUInt32(),d=h.getUInt32();u[n[f]]=o[d]}h.release();break}case 3:this.type=c.getUInt32();break;case 4:this._pbfGeometry=c.getMessage();break;default:c.skip()}}getGeometry(s){if(this._geometry!==void 0)return this._geometry;if(!this._pbfGeometry)return null;const r=this._pbfGeometry.asUnsafe();let a,n;this._pbfGeometry=null,s?s.reset(this.type):a=[];let o,c=Le.moveTo,h=0,u=0,f=0;for(;!r.empty();){if(h===0){const d=r.getUInt32();c=7&d,h=d>>3}switch(h--,c){case Le.moveTo:u+=r.getSInt32(),f+=r.getSInt32(),s?s.moveTo(u,f):a&&(n&&a.push(n),n=[],n.push(new C(u,f)));break;case Le.lineTo:u+=r.getSInt32(),f+=r.getSInt32(),s?s.lineTo(u,f):n&&n.push(new C(u,f));break;case Le.close:s?s.close():n&&!n[0].equals(u,f)&&n.push(n[0].clone());break;default:throw r.release(),new Error("Invalid path operation")}}return s?o=s.result():a&&(n&&a.push(n),o=a),r.release(),this._geometry=o,o}},me=class extends H{constructor(){super(12)}add(s,r,a){const n=this.array;n.push(s),n.push(r),n.push(a)}};class it{constructor(s){this.extent=Te,this.keys=[],this.values=[],this._pbfLayer=s.clone();const r=s.asUnsafe();for(;r.next();)switch(r.tag()){case 1:this.name=r.getString();break;case 3:this.keys.push(r.getString());break;case 4:this.values.push(r.processMessage(it._parseValue));break;case 5:this.extent=r.getUInt32();break;default:r.skip()}}getData(){return this._pbfLayer}static _parseValue(s){for(;s.next();)switch(s.tag()){case 1:return s.getString();case 2:return s.getFloat();case 3:return s.getDouble();case 4:return s.getInt64();case 5:return s.getUInt64();case 6:return s.getSInt64();case 7:return s.getBool();default:s.skip()}return null}}let $s=class extends H{constructor(s){super(s)}add(s,r,a,n,o,c,h,u,f,d,p,g){const y=this.array;let m=H.i1616to32(s,r);y.push(m);const T=31;m=H.i8888to32(Math.round(T*a),Math.round(T*n),Math.round(T*o),Math.round(T*c)),y.push(m),m=H.i8888to32(Math.round(T*h),Math.round(T*u),Math.round(T*f),Math.round(T*d)),y.push(m),m=H.i1616to32(p,0),y.push(m),g&&y.push(...g)}},Ns=class extends H{constructor(s){super(s)}add(s,r,a){const n=this.array;n.push(H.i1616to32(s,r)),a&&n.push(...a)}};class zs extends H{constructor(s){super(s)}add(s,r,a,n,o,c,h){const u=this.array,f=this.index;let d=H.i1616to32(s,r);u.push(d);const p=15;return d=H.i8888to32(Math.round(p*a),Math.round(p*n),o,c),u.push(d),h&&u.push(...h),f}}class bt extends H{constructor(s){super(s)}add(s,r,a,n,o,c,h,u,f,d,p,g){const y=this.array;let m=H.i1616to32(s,r);y.push(m),m=H.i1616to32(Math.round(8*a),Math.round(8*n)),y.push(m),m=H.i8888to32(o/4,c/4,u,f),y.push(m),m=H.i8888to32(0,Mt(h),10*d,Math.min(10*p,255)),y.push(m),g&&y.push(...g)}}class Gs extends H{constructor(s){super(s)}add(s,r,a,n,o){const c=this.array,h=H.i1616to32(2*s+a,2*r+n);c.push(h),o&&c.push(...o)}}class qe{constructor(s,r,a){this.layerExtent=Te,this._features=[],this.layer=s,this.zoom=r,this._spriteInfo=a,this._filter=s.getFeatureFilter()}pushFeature(s){this._filter&&!this._filter.filter(s,this.zoom)||this._features.push(s)}hasFeatures(){return this._features.length>0}getResources(s,r,a){}}let Hs=class extends qe{constructor(s,r,a,n,o){super(s,r,a),this.type=je.CIRCLE,this._circleVertexBuffer=n,this._circleIndexBuffer=o}get circleIndexStart(){return this._circleIndexStart}get circleIndexCount(){return this._circleIndexCount}processFeatures(s){const r=this._circleVertexBuffer,a=this._circleIndexBuffer;this._circleIndexStart=3*a.index,this._circleIndexCount=0;const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);for(const c of this._features){const h=c.getGeometry(s);if(!h)continue;const u=n.circleMaterial.encodeAttributes(c,o,n);for(const f of h)if(f)for(const d of f){const p=r.index;r.add(d.x,d.y,0,0,u),r.add(d.x,d.y,0,1,u),r.add(d.x,d.y,1,0,u),r.add(d.x,d.y,1,1,u),a.add(p,p+1,p+2),a.add(p+1,p+2,p+3),this._circleIndexCount+=6}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this._circleVertexBuffer.array.length,s+=this._circleIndexBuffer.array.length;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let o=0;o<this.layerUIDs.length;o++)r[n++]=this.layerUIDs[o];r[n++]=this._circleIndexStart,r[n++]=this._circleIndexCount,r[n++]=this._circleVertexBuffer.array.length;for(let o=0;o<this._circleVertexBuffer.array.length;o++)a[n++]=this._circleVertexBuffer.array[o];r[n++]=this._circleIndexBuffer.array.length;for(let o=0;o<this._circleIndexBuffer.array.length;o++)r[n++]=this._circleIndexBuffer.array[o];return r.buffer}},Ks=class Rt extends qe{constructor(s,r,a,n,o,c,h){super(s,r,a),this.type=je.FILL,this._patternMap=new Map,this._fillVertexBuffer=n,this._fillIndexBuffer=o,this._outlineVertexBuffer=c,this._outlineIndexBuffer=h}get fillIndexStart(){return this._fillIndexStart}get fillIndexCount(){return this._fillIndexCount}get outlineIndexStart(){return this._outlineIndexStart}get outlineIndexCount(){return this._outlineIndexCount}getResources(s,r,a){const n=this.layer,o=this.zoom,c=n.getPaintProperty("fill-pattern");if(c)if(c.isDataDriven)for(const h of this._features)r(c.getValue(o,h),!0);else r(c.getValue(o),!0)}processFeatures(s){this._fillIndexStart=3*this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=3*this._outlineIndexBuffer.index,this._outlineIndexCount=0;const r=this.layer,a=this.zoom,{fillMaterial:n,outlineMaterial:o,hasDataDrivenFill:c,hasDataDrivenOutline:h}=r;s&&s.setExtent(this.layerExtent);const u=r.getPaintProperty("fill-pattern"),f=u==null?void 0:u.isDataDriven;let d=!u&&r.getPaintValue("fill-antialias",a);if(r.outlineUsesFillColor){if(d&&!r.hasDataDrivenOpacity){const y=r.getPaintValue("fill-opacity",a),m=r.getPaintValue("fill-opacity",a+1);y<1&&m<1&&(d=!1)}if(d&&!r.hasDataDrivenColor){const y=r.getPaintValue("fill-color",a),m=r.getPaintValue("fill-color",a+1);y[3]<1&&m[3]<1&&(d=!1)}}const p=this._features,g=s==null?void 0:s.validateTessellation;if(f){const y=[];for(const m of p){const T=u.getValue(a,m),B=this._spriteInfo[T];if(!(B!=null&&B.rect))continue;const _=n.encodeAttributes(m,a,r,B),b=d&&h?o.encodeAttributes(m,a,r):[],I=m.getGeometry(s);y.push({ddFillAttributes:_,ddOutlineAttributes:b,page:B.page,geometry:I}),y.sort(((w,P)=>w.page-P.page));for(const{ddFillAttributes:w,ddOutlineAttributes:P,page:A,geometry:M}of y)this._processFeature(M,d,r.outlineUsesFillColor,w,P,g,A)}}else for(const y of p){const m=c?n.encodeAttributes(y,a,r):null,T=d&&h?o.encodeAttributes(y,a,r):null,B=y.getGeometry(s);this._processFeature(B,d,r.outlineUsesFillColor,m,T,g)}}serialize(){let s=10;s+=this.layerUIDs.length,s+=this._fillVertexBuffer.array.length,s+=this._fillIndexBuffer.array.length,s+=this._outlineVertexBuffer.array.length,s+=this._outlineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let h=0;h<this.layerUIDs.length;h++)r[n++]=this.layerUIDs[h];r[n++]=this._fillIndexStart,r[n++]=this._fillIndexCount,r[n++]=this._outlineIndexStart,r[n++]=this._outlineIndexCount;const o=this._patternMap,c=o.size;if(r[n++]=c,c>0)for(const[h,[u,f]]of o)r[n++]=h,r[n++]=u,r[n++]=f;r[n++]=this._fillVertexBuffer.array.length;for(let h=0;h<this._fillVertexBuffer.array.length;h++)a[n++]=this._fillVertexBuffer.array[h];r[n++]=this._fillIndexBuffer.array.length;for(let h=0;h<this._fillIndexBuffer.array.length;h++)r[n++]=this._fillIndexBuffer.array[h];r[n++]=this._outlineVertexBuffer.array.length;for(let h=0;h<this._outlineVertexBuffer.array.length;h++)a[n++]=this._outlineVertexBuffer.array[h];r[n++]=this._outlineIndexBuffer.array.length;for(let h=0;h<this._outlineIndexBuffer.array.length;h++)r[n++]=this._outlineIndexBuffer.array[h];return r.buffer}_processFeature(s,r,a,n,o,c,h){if(!s)return;const u=s.length,f=!o||o.length===0;if(r&&(!a||f))for(let g=0;g<u;g++)this._processOutline(s[g],o);const d=32;let p;for(let g=0;g<u;g++){const y=Rt._area(s[g]);y>d?(p!==void 0&&this._processFill(s,p,n,c,h),p=[g]):y<-32&&p!==void 0&&p.push(g)}p!==void 0&&this._processFill(s,p,n,c,h)}_processOutline(s,r){const a=this._outlineVertexBuffer,n=this._outlineIndexBuffer,o=n.index;let c,h,u;const f=new C(0,0),d=new C(0,0),p=new C(0,0);let g=-1,y=-1,m=-1,T=-1,B=-1,_=!1;const b=0;let I=s.length;if(I<2)return;const w=s[b];let P=s[I-1];for(;I&&P.isEqual(w);)--I,P=s[I-1];if(!(I-b<2)){for(let A=b;A<I;++A){A===b?(c=s[I-1],h=s[b],u=s[b+1],f.assignSub(h,c),f.normalize(),f.rightPerpendicular()):(c=h,h=u,u=A!==I-1?s[A+1]:s[b],f.assign(d));const M=this._isClipEdge(c,h);T===-1&&(_=M),d.assignSub(u,h),d.normalize(),d.rightPerpendicular();const R=f.x*d.y-f.y*d.x;p.assignAdd(f,d),p.normalize();const S=-p.x*-f.x+-p.y*-f.y;let v=Math.abs(S!==0?1/S:1);v>8&&(v=8),R>=0?(m=a.add(h.x,h.y,f.x,f.y,0,1,r),T===-1&&(T=m),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),y=a.add(h.x,h.y,v*-p.x,v*-p.y,0,-1,r),B===-1&&(B=y),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),g=y,y=m,m=a.add(h.x,h.y,p.x,p.y,0,1,r),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),y=a.add(h.x,h.y,d.x,d.y,0,1,r),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m)):(m=a.add(h.x,h.y,v*p.x,v*p.y,0,1,r),T===-1&&(T=m),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),y=a.add(h.x,h.y,-f.x,-f.y,0,-1,r),B===-1&&(B=y),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),g=y,y=m,m=a.add(h.x,h.y,-p.x,-p.y,0,-1,r),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m),g=a.add(h.x,h.y,-d.x,-d.y,0,-1,r),g>=0&&y>=0&&m>=0&&!M&&n.add(g,y,m))}g>=0&&y>=0&&T>=0&&!_&&n.add(g,y,T),g>=0&&T>=0&&B>=0&&!_&&n.add(g,B,T),this._outlineIndexCount+=3*(n.index-o)}}_processFill(s,r,a,n,o){n=!0;let c;r.length>1&&(c=[]);let h=0;for(const p of r)h!==0&&c.push(h),h+=s[p].length;const u=2*h,f=ot.acquire();for(const p of r){const g=s[p],y=g.length;for(let m=0;m<y;++m)f.push(g[m].x,g[m].y)}const d=dt(f,c,2);if(n&&dt.deviation(f,c,2,d)>0){const p=r.map((m=>s[m].length)),{buffer:g,vertexCount:y}=Ht(f,p);if(y>0){const m=this._fillVertexBuffer.index;for(let T=0;T<y;T++)this._fillVertexBuffer.add(g[2*T],g[2*T+1],a);for(let T=0;T<y;T+=3){const B=m+T;this._fillIndexBuffer.add(B,B+1,B+2)}if(o!==void 0){const T=this._patternMap,B=T.get(o);B?B[1]+=y:T.set(o,[this._fillIndexStart+this._fillIndexCount,y])}this._fillIndexCount+=y}}else{const p=d.length;if(p>0){const g=this._fillVertexBuffer.index;let y=0;for(;y<u;)this._fillVertexBuffer.add(f[y++],f[y++],a);let m=0;for(;m<p;)this._fillIndexBuffer.add(g+d[m++],g+d[m++],g+d[m++]);if(o!==void 0){const T=this._patternMap,B=T.get(o);B?B[1]+=p:T.set(o,[this._fillIndexStart+this._fillIndexCount,p])}this._fillIndexCount+=p}}ot.release(f)}_isClipEdge(s,r){return s.x===r.x?s.x<=-64||s.x>=4160:s.y===r.y&&(s.y<=-64||s.y>=4160)}static _area(s){let r=0;const a=s.length-1;for(let n=0;n<a;n++)r+=(s[n].x-s[n+1].x)*(s[n].y+s[n+1].y);return r+=(s[a].x-s[0].x)*(s[a].y+s[0].y),.5*r}};const js=65535;class Ws extends qe{constructor(s,r,a,n,o){super(s,r,a),this.type=je.LINE,this._tessellationOptions={pixelCoordRatio:8,halfWidth:0,offset:0},this._patternMap=new Map,this.tessellationProperties={_lineVertexBuffer:null,_lineIndexBuffer:null,_ddValues:null},this.tessellationProperties._lineVertexBuffer=n,this.tessellationProperties._lineIndexBuffer=o,this._lineTessellator=new Kt(qs(this.tessellationProperties),Ys(this.tessellationProperties),s.canUseThinTessellation)}get lineIndexStart(){return this._lineIndexStart}get lineIndexCount(){return this._lineIndexCount}getResources(s,r,a){const n=this.layer,o=this.zoom,c=n.getPaintProperty("line-pattern"),h=n.getPaintProperty("line-dasharray"),u=n.getLayoutProperty("line-cap");if(!c&&!h)return;const f=(u==null?void 0:u.getValue(o))||0,d=u==null?void 0:u.isDataDriven,p=c==null?void 0:c.isDataDriven,g=h==null?void 0:h.isDataDriven;if(p||g)for(const y of this._features)r(p?c.getValue(o,y):this._getDashArrayKey(y,o,n,h,d,u,f));else if(c)r(c.getValue(o));else if(h){const y=h.getValue(o);r(n.getDashKey(y,f))}}processFeatures(s){this._lineIndexStart=3*this.tessellationProperties._lineIndexBuffer.index,this._lineIndexCount=0;const r=this.layer,a=this.zoom,n=this._features,o=this._tessellationOptions,{hasDataDrivenLine:c,lineMaterial:h}=r;s&&s.setExtent(this.layerExtent);const u=r.getPaintProperty("line-pattern"),f=r.getPaintProperty("line-dasharray"),d=u==null?void 0:u.isDataDriven,p=f==null?void 0:f.isDataDriven;let g;g=r.getLayoutProperty("line-cap");const y=g!=null&&g.isDataDriven?g:null,m=y?null:r.getLayoutValue("line-cap",a),T=m||0,B=!!y;g=r.getLayoutProperty("line-join");const _=g!=null&&g.isDataDriven?g:null,b=_?null:r.getLayoutValue("line-join",a);g=r.getLayoutProperty("line-miter-limit");const I=g!=null&&g.isDataDriven?g:null,w=I?null:r.getLayoutValue("line-miter-limit",a);g=r.getLayoutProperty("line-round-limit");const P=g!=null&&g.isDataDriven?g:null,A=P?null:r.getLayoutValue("line-round-limit",a);g=r.getPaintProperty("line-width");const M=g!=null&&g.isDataDriven?g:null,R=M?null:r.getPaintValue("line-width",a);g=r.getPaintProperty("line-offset");const S=g!=null&&g.isDataDriven?g:null,v=S?null:r.getPaintValue("line-offset",a);if(d||p){const U=[];for(const V of n){const N=d?u.getValue(a,V):this._getDashArrayKey(V,a,r,f,B,y,T),E=this._spriteInfo[N];if(!(E!=null&&E.rect))continue;const $=h.encodeAttributes(V,a,r,E),K=V.getGeometry(s);U.push({ddAttributes:$,page:E.page,cap:y?y.getValue(a,V):m,join:_?_.getValue(a,V):b,miterLimit:I?I.getValue(a,V):w,roundLimit:P?P.getValue(a,V):A,halfWidth:.5*(M?M.getValue(a,V):R),offset:S?S.getValue(a,V):v,geometry:K})}U.sort(((V,N)=>V.page-N.page)),o.textured=!0;for(const{ddAttributes:V,page:N,cap:E,join:$,miterLimit:K,roundLimit:fe,halfWidth:te,offset:le,geometry:de}of U)o.capType=E,o.joinType=$,o.miterLimit=K,o.roundLimit=fe,o.halfWidth=te,o.offset=le,this._processFeature(de,V,N)}else{if(u){const U=u.getValue(a),V=this._spriteInfo[U];if(!(V!=null&&V.rect))return}o.textured=!(!u&&!f),o.capType=m,o.joinType=b,o.miterLimit=w,o.roundLimit=A,o.halfWidth=.5*R,o.offset=v;for(const U of n){const V=c?h.encodeAttributes(U,a,r):null;y&&(o.capType=y.getValue(a,U)),_&&(o.joinType=_.getValue(a,U)),I&&(o.miterLimit=I.getValue(a,U)),P&&(o.roundLimit=P.getValue(a,U)),M&&(o.halfWidth=.5*M.getValue(a,U)),S&&(o.offset=S.getValue(a,U));const N=U.getGeometry(s);this._processFeature(N,V)}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this.tessellationProperties._lineVertexBuffer.array.length,s+=this.tessellationProperties._lineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let h=0;h<this.layerUIDs.length;h++)r[n++]=this.layerUIDs[h];r[n++]=this._lineIndexStart,r[n++]=this._lineIndexCount;const o=this._patternMap,c=o.size;if(r[n++]=c,c>0)for(const[h,[u,f]]of o)r[n++]=h,r[n++]=u,r[n++]=f;r[n++]=this.tessellationProperties._lineVertexBuffer.array.length;for(let h=0;h<this.tessellationProperties._lineVertexBuffer.array.length;h++)a[n++]=this.tessellationProperties._lineVertexBuffer.array[h];r[n++]=this.tessellationProperties._lineIndexBuffer.array.length;for(let h=0;h<this.tessellationProperties._lineIndexBuffer.array.length;h++)r[n++]=this.tessellationProperties._lineIndexBuffer.array[h];return r.buffer}_processFeature(s,r,a){if(!s)return;const n=s.length;for(let o=0;o<n;o++)this._processGeometry(s[o],r,a)}_processGeometry(s,r,a){if(s.length<2)return;const n=.001;let o,c,h=s[0],u=1;for(;u<s.length;)o=s[u].x-h.x,c=s[u].y-h.y,o*o+c*c<n*n?s.splice(u,1):(h=s[u],++u);if(s.length<2)return;const f=this.tessellationProperties._lineIndexBuffer,d=3*f.index;this._tessellationOptions.initialDistance=0,this._tessellationOptions.wrapDistance=js,this.tessellationProperties._ddValues=r,this._lineTessellator.tessellate(s,this._tessellationOptions);const p=3*f.index-d;if(a!==void 0){const g=this._patternMap,y=g.get(a);y?y[1]+=p:g.set(a,[d+this._lineIndexCount,p])}this._lineIndexCount+=p}_getDashArrayKey(s,r,a,n,o,c,h){const u=o?c.getValue(r,s):h,f=n.getValue(r,s);return a.getDashKey(f,u)}}const qs=l=>(s,r,a,n,o,c,h,u,f,d,p)=>(l._lineVertexBuffer.add(s,r,h,u,a,n,o,c,f,d,p,l._ddValues),l._lineVertexBuffer.index-1),Ys=l=>(s,r,a)=>{l._lineIndexBuffer.add(s,r,a)},wt=10;function Zs(l,s){return l.iconMosaicItem&&s.iconMosaicItem?l.iconMosaicItem.page===s.iconMosaicItem.page?0:l.iconMosaicItem.page-s.iconMosaicItem.page:l.iconMosaicItem&&!s.iconMosaicItem?1:!l.iconMosaicItem&&s.iconMosaicItem?-1:0}const X=class X extends qe{constructor(s,r,a,n,o,c,h,u,f){super(r,a,f.getSpriteItems()),this.type=je.SYMBOL,this._markerMap=new Map,this._glyphMap=new Map,this._glyphBufferDataStorage=new Map,this._isIconSDF=!1,this._sourceTileKey=s,this._iconVertexBuffer=n,this._iconIndexBuffer=o,this._textVertexBuffer=c,this._textIndexBuffer=h,this._placementEngine=u,this._workerTileHandler=f}get markerPageMap(){return this._markerMap}get glyphsPageMap(){return this._glyphMap}get symbolInstances(){return this._symbolInstances}getResources(s,r,a){const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);const c=n.getLayoutProperty("icon-image"),h=n.getLayoutProperty("text-field");let u=n.getLayoutProperty("text-transform"),f=n.getLayoutProperty("text-font");const d=[];let p,g,y,m;c&&!c.isDataDriven&&(p=c.getValue(o)),h&&!h.isDataDriven&&(g=h.getValue(o)),u&&u.isDataDriven||(y=n.getLayoutValue("text-transform",o),u=null),f&&f.isDataDriven||(m=n.getLayoutValue("text-font",o),f=null);for(const T of this._features){const B=T.getGeometry(s);if(!B||B.length===0)continue;let _,b;c&&(_=c.isDataDriven?c.getValue(o,T):this._replaceKeys(p,T.values),_&&r(_));let I=!1;if(h&&(b=h.isDataDriven?h.getValue(o,T):this._replaceKeys(g,T.values),b)){switch(b=b.replaceAll("\\n",`
`),u&&(y=u.getValue(o,T)),y){case ct.LOWERCASE:b=b.toLowerCase();break;case ct.UPPERCASE:b=b.toUpperCase()}if(X._bidiEngine.hasBidiChar(b)){let A;A=X._bidiEngine.checkContextual(b)==="rtl"?"IDNNN":"ICNNN",b=X._bidiEngine.bidiTransform(b,A,"VLYSN"),I=!0}if(b.length>0){f&&(m=f.getValue(o,T));for(const A of m){let M=a[A];M||(M=a[A]=new Set);for(const R of b){const S=R.codePointAt(0);S!=null&&M.add(S)}}}}if(!_&&!b)continue;const w=n.getLayoutValue("symbol-sort-key",o,T),P={feature:T,sprite:_,label:b,rtl:I,geometry:B,hash:(b?lt(b):0)^(_?lt(_):0),priority:w,textFont:m};d.push(P)}this._symbolFeatures=d}processFeatures(s){s&&s.setExtent(this.layerExtent);const r=this.layer,a=this.zoom,n=r.getLayoutValue("symbol-placement",a),o=n!==Je.POINT,c=r.getLayoutValue("symbol-spacing",a)*Pe,h=r.getLayoutProperty("icon-image"),u=r.getLayoutProperty("text-field"),f=h?new Ct(r,a,o):null,d=u?new Ut(r,a,o):null,p=this._workerTileHandler;let g;h&&(g=p.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();const y=[];let m=1;d!=null&&d.size&&(m=d.size/ae);const T=d?d.maxAngle*st:0,B=d?d.size*Pe:0;for(const _ of this._symbolFeatures){let b;f&&g&&_.sprite&&(b=g[_.sprite],b&&b.sdf&&(this._isIconSDF=!0));let I;b&&f.update(a,_.feature);let w=0;const P=_.label;if(P){Ft(d),d.update(a,_.feature);const A=o&&d.rotationAlignment===Ie.MAP?d.keepUpright:d.writingMode&&d.writingMode.includes(Et.VERTICAL);let M=.5;switch(d.anchor){case O.TOP_LEFT:case O.LEFT:case O.BOTTOM_LEFT:M=0;break;case O.TOP_RIGHT:case O.RIGHT:case O.BOTTOM_RIGHT:M=1}let R=.5;switch(d.anchor){case O.TOP_LEFT:case O.TOP:case O.TOP_RIGHT:R=0;break;case O.BOTTOM_LEFT:case O.BOTTOM:case O.BOTTOM_RIGHT:R=1}let S=.5;switch(d.justify){case Xe.AUTO:S=M;break;case Xe.LEFT:S=0;break;case Xe.RIGHT:S=1}const v=d.letterSpacing*ae,U=o?0:d.maxWidth*ae,V=d.lineHeight*ae,N=_.textFont.map((E=>p.getGlyphItems(E)));if(I=new kt(N,U,V,v,M,R,S).getShaping(P,_.rtl,A),I&&I.length>0){let E=1e30,$=-1e30;for(const K of I)E=Math.min(E,K.x),$=Math.max($,K.x);w=($-E+2*ae)*m*Pe}}for(let A of _.geometry){const M=[];if(n===Je.LINE){if(I!=null&&I.length&&(d!=null&&d.size)){const R=d.size*Pe*(2+Math.min(2,4*Math.abs(d.offset[1])));A=X._smoothVertices(A,R)}X._pushAnchors(M,A,c,w)}else n===Je.LINE_CENTER?X._pushCenterAnchor(M,A):_.feature.type===$t.Polygon?X._pushCentroid(M,A):M.push(new $e(A[0].x,A[0].y));for(const R of M){if(R.x<0||R.x>Te||R.y<0||R.y>Te||o&&w>0&&(d==null?void 0:d.rotationAlignment)===Ie.MAP&&!X._honorsTextMaxAngle(A,R,w,T,B))continue;const S={shaping:I,line:A,iconMosaicItem:b,anchor:R,symbolFeature:_,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};y.push(S),this._processFeature(S,f,d)}}}y.sort(Zs),this._addPlacedGlyphs(),this._symbolInstances=y}serialize(){let s=14;s+=this.layerUIDs.length,s+=3*this.markerPageMap.size,s+=3*this.glyphsPageMap.size,s+=X._symbolsSerializationLength(this._symbolInstances),s+=this._iconVertexBuffer.array.length,s+=this._iconIndexBuffer.array.length,s+=this._textVertexBuffer.array.length,s+=this._textIndexBuffer.array.length;const r=new Uint32Array(s),a=new Int32Array(r.buffer),n=new Float32Array(r.buffer),[o,c,h]=this._sourceTileKey.split("/");let u=0;r[u++]=this.type,r[u++]=this.layerUIDs.length;for(let f=0;f<this.layerUIDs.length;f++)r[u++]=this.layerUIDs[f];r[u++]=this._isIconSDF?1:0,r[u++]=parseFloat(o),r[u++]=parseFloat(c),r[u++]=parseFloat(h),r[u++]=this.markerPageMap.size;for(const[f,[d,p]]of this.markerPageMap)r[u++]=f,r[u++]=d,r[u++]=p;r[u++]=this.glyphsPageMap.size;for(const[f,[d,p]]of this.glyphsPageMap)r[u++]=f,r[u++]=d,r[u++]=p;r[u++]=this._iconVertexBuffer.index/4,r[u++]=this._textVertexBuffer.index/4,u=X.serializeSymbols(r,a,n,u,this._symbolInstances),r[u++]=this._iconVertexBuffer.array.length;for(let f=0;f<this._iconVertexBuffer.array.length;f++)a[u++]=this._iconVertexBuffer.array[f];r[u++]=this._iconIndexBuffer.array.length;for(let f=0;f<this._iconIndexBuffer.array.length;f++)r[u++]=this._iconIndexBuffer.array[f];r[u++]=this._textVertexBuffer.array.length;for(let f=0;f<this._textVertexBuffer.array.length;f++)a[u++]=this._textVertexBuffer.array[f];r[u++]=this._textIndexBuffer.array.length;for(let f=0;f<this._textIndexBuffer.array.length;f++)r[u++]=this._textIndexBuffer.array[f];return r.buffer}static _symbolsSerializationLength(s){let r=0;r+=1;for(const a of s||[]){r+=5,r+=1;for(const n of a.textColliders)r+=wt;for(const n of a.iconColliders)r+=wt;r+=1,r+=2*a.textVertexRanges.length,r+=1,r+=2*a.iconVertexRanges.length}return r}static serializeSymbols(s,r,a,n,o){o=o||[],r[n++]=o.length;for(const c of o){r[n++]=c.anchor.x,r[n++]=c.anchor.y,r[n++]=c.symbolFeature.hash,r[n++]=c.symbolFeature.priority,r[n++]=c.symbolFeature.feature.featureIndex,r[n++]=c.textColliders.length+c.iconColliders.length;for(const h of c.textColliders)r[n++]=h.xTile,r[n++]=h.yTile,r[n++]=h.dxPixels,r[n++]=h.dyPixels,r[n++]=h.hard?1:0,r[n++]=h.partIndex,a[n++]=h.minLod,a[n++]=h.maxLod,r[n++]=h.width,r[n++]=h.height;for(const h of c.iconColliders)r[n++]=h.xTile,r[n++]=h.yTile,r[n++]=h.dxPixels,r[n++]=h.dyPixels,r[n++]=h.hard?1:0,r[n++]=h.partIndex,a[n++]=h.minLod,a[n++]=h.maxLod,r[n++]=h.width,r[n++]=h.height;r[n++]=c.textVertexRanges.length;for(const[h,u]of c.textVertexRanges)r[n++]=h,r[n++]=u;r[n++]=c.iconVertexRanges.length;for(const[h,u]of c.iconVertexRanges)r[n++]=h,r[n++]=u}return n}_replaceKeys(s,r){return s.replaceAll(/{([^{}]+)}/g,((a,n)=>n in r?r[n]:""))}_processFeature(s,r,a){const{line:n,iconMosaicItem:o,shaping:c,anchor:h}=s,u=this.zoom,f=this.layer,d=!!o;let p=!0;d&&(p=(r==null?void 0:r.optional)||!o);const g=c&&c.length>0,y=!g||(a==null?void 0:a.optional);let m,T;if(d&&(m=this._placementEngine.getIconPlacement(h,o,r)),(m||p)&&(g&&(T=this._placementEngine.getTextPlacement(h,c,n,a)),T||y)){if(m&&T||(y||p?y||T?p||m||(T=null):m=null:(m=null,T=null)),T){const B=f.hasDataDrivenText?f.textMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._storePlacedGlyphs(s,T.shapes,u,a.rotationAlignment,B),T.textColliders){s.textColliders=T.textColliders;for(const _ of T.textColliders){_.minLod=Math.max(u+he(_.minLod),0),_.maxLod=Math.min(u+he(_.maxLod),25);const b=_.angle;if(b){const I=Math.cos(b),w=Math.sin(b),P=_.dxPixels*I-_.dyPixels*w,A=_.dxPixels*w+_.dyPixels*I,M=(_.dxPixels+_.width)*I-_.dyPixels*w,R=(_.dxPixels+_.width)*w+_.dyPixels*I,S=_.dxPixels*I-(_.dyPixels+_.height)*w,v=_.dxPixels*w+(_.dyPixels+_.height)*I,U=(_.dxPixels+_.width)*I-(_.dyPixels+_.height)*w,V=(_.dxPixels+_.width)*w+(_.dyPixels+_.height)*I,N=Math.min(P,M,S,U),E=Math.max(P,M,S,U),$=Math.min(A,R,v,V),K=Math.max(A,R,v,V);_.dxPixels=N,_.dyPixels=$,_.width=E-N,_.height=K-$}}}}if(m){const B=f.hasDataDrivenIcon?f.iconMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._addPlacedIcons(s,m.shapes,u,o.page,r.rotationAlignment===Ie.VIEWPORT,B),m.iconColliders){s.iconColliders=m.iconColliders;for(const _ of m.iconColliders){_.minLod=Math.max(u+he(_.minLod),0),_.maxLod=Math.min(u+he(_.maxLod),25);const b=_.angle;if(b){const I=Math.cos(b),w=Math.sin(b),P=_.dxPixels*I-_.dyPixels*w,A=_.dxPixels*w+_.dyPixels*I,M=(_.dxPixels+_.width)*I-_.dyPixels*w,R=(_.dxPixels+_.width)*w+_.dyPixels*I,S=_.dxPixels*I-(_.dyPixels+_.height)*w,v=_.dxPixels*w+(_.dyPixels+_.height)*I,U=(_.dxPixels+_.width)*I-(_.dyPixels+_.height)*w,V=(_.dxPixels+_.width)*w+(_.dyPixels+_.height)*I,N=Math.min(P,M,S,U),E=Math.max(P,M,S,U),$=Math.min(A,R,v,V),K=Math.max(A,R,v,V);_.dxPixels=N,_.dyPixels=$,_.width=E-N,_.height=K-$}}}}}}_addPlacedIcons(s,r,a,n,o,c){const h=Math.max(a-1,0),u=this._iconVertexBuffer,f=this._iconIndexBuffer,d=this._markerMap;for(const p of r){const g=o?0:Math.max(a+he(p.minzoom),h),y=o?25:Math.min(a+he(p.maxzoom),25);if(y<=g)continue;const m=p.tl,T=p.tr,B=p.bl,_=p.br,b=p.mosaicRect,I=p.labelAngle,w=p.minAngle,P=p.maxAngle,A=p.anchor,M=u.index,R=b.x,S=b.y,v=R+b.width,U=S+b.height,V=u.index;u.add(A.x,A.y,m.x,m.y,R,S,I,w,P,g,y,c),u.add(A.x,A.y,T.x,T.y,v,S,I,w,P,g,y,c),u.add(A.x,A.y,B.x,B.y,R,U,I,w,P,g,y,c),u.add(A.x,A.y,_.x,_.y,v,U,I,w,P,g,y,c),s.iconVertexRanges.length>0&&s.iconVertexRanges[0][0]+s.iconVertexRanges[0][1]===V?s.iconVertexRanges[0][1]+=4:s.iconVertexRanges.push([V,4]),f.add(M,M+1,M+2),f.add(M+1,M+2,M+3),d.has(n)?d.get(n)[1]+=6:d.set(n,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}}_addPlacedGlyphs(){const s=this._textVertexBuffer,r=this._textIndexBuffer,a=this._glyphMap;for(const[n,o]of this._glyphBufferDataStorage)for(const c of o){const h=s.index,u=c.symbolInstance,f=c.ddAttributes,d=s.index;s.add(c.glyphAnchor[0],c.glyphAnchor[1],c.tl[0],c.tl[1],c.xmin,c.ymin,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,f),s.add(c.glyphAnchor[0],c.glyphAnchor[1],c.tr[0],c.tr[1],c.xmax,c.ymin,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,f),s.add(c.glyphAnchor[0],c.glyphAnchor[1],c.bl[0],c.bl[1],c.xmin,c.ymax,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,f),s.add(c.glyphAnchor[0],c.glyphAnchor[1],c.br[0],c.br[1],c.xmax,c.ymax,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,f),u.textVertexRanges.length>0&&u.textVertexRanges[0][0]+u.textVertexRanges[0][1]===d?u.textVertexRanges[0][1]+=4:u.textVertexRanges.push([d,4]),r.add(h,h+1,h+2),r.add(h+1,h+2,h+3),a.has(n)?a.get(n)[1]+=6:a.set(n,[this._textIndexStart+this._textIndexCount,6]),this._textIndexCount+=6}this._glyphBufferDataStorage.clear()}_storePlacedGlyphs(s,r,a,n,o){const c=Math.max(a-1,0),h=n===Ie.VIEWPORT;let u,f,d,p,g,y,m,T,B,_,b;for(const I of r)u=h?0:Math.max(a+he(I.minzoom),c),f=h?25:Math.min(a+he(I.maxzoom),25),!(f<=u)&&(d=I.tl,p=I.tr,g=I.bl,y=I.br,m=I.labelAngle,T=I.minAngle,B=I.maxAngle,_=I.anchor,b=I.mosaicRect,this._glyphBufferDataStorage.has(I.page)||this._glyphBufferDataStorage.set(I.page,[]),this._glyphBufferDataStorage.get(I.page).push({glyphAnchor:[_.x,_.y],tl:[d.x,d.y],tr:[p.x,p.y],bl:[g.x,g.y],br:[y.x,y.y],xmin:b.x,ymin:b.y,xmax:b.x+b.width,ymax:b.y+b.height,labelAngle:m,minAngle:T,maxAngle:B,minLod:u,maxLod:f,placementLod:c,symbolInstance:s,ddAttributes:o}))}static _pushAnchors(s,r,a,n){a+=n;let o=0;const c=r.length-1;for(let g=0;g<c;g++)o+=C.distance(r[g],r[g+1]);let h=n||a;if(h*=.5,o<=h)return;const u=h/o;let f=0,d=-(a=o/Math.max(Math.round(o/a),1))/2;const p=r.length-1;for(let g=0;g<p;g++){const y=r[g],m=r[g+1],T=m.x-y.x,B=m.y-y.y,_=Math.sqrt(T*T+B*B);let b;for(;d+a<f+_;){d+=a;const I=(d-f)/_,w=Ee(y.x,m.x,I),P=Ee(y.y,m.y,I);b===void 0&&(b=Math.atan2(B,T)),s.push(new $e(w,P,b,g,u))}f+=_}}static _pushCenterAnchor(s,r){let a=0;const n=r.length-1;for(let u=0;u<n;u++)a+=C.distance(r[u],r[u+1]);const o=a/2;let c=0;const h=r.length-1;for(let u=0;u<h;u++){const f=r[u],d=r[u+1],p=d.x-f.x,g=d.y-f.y,y=Math.sqrt(p*p+g*g);if(o<c+y){const m=(o-c)/y,T=Ee(f.x,d.x,m),B=Ee(f.y,d.y,m),_=Math.atan2(g,p);return void s.push(new $e(T,B,_,u,0))}c+=y}}static _deviation(s,r,a){const n=(r.x-s.x)*(a.x-r.x)+(r.y-s.y)*(a.y-r.y),o=(r.x-s.x)*(a.y-r.y)-(r.y-s.y)*(a.x-r.x);return Math.atan2(o,n)}static _honorsTextMaxAngle(s,r,a,n,o){let c=0;const h=a/2;let u=new C(r.x,r.y),f=r.segment+1;for(;c>-h;){if(--f,f<0)return!1;c-=C.distance(s[f],u),u=s[f]}c+=C.distance(s[f],s[f+1]);const d=[];let p=0;const g=s.length;for(;c<h;){const y=s[f];let m,T=f;do{if(++T,T===g)return!1;m=s[T]}while(m.isEqual(y));let B,_=T;do{if(++_,_===g)return!1;B=s[_]}while(B.isEqual(m));const b=this._deviation(y,m,B);for(d.push({deviation:b,distToAnchor:c}),p+=b;c-d[0].distToAnchor>o;)p-=d.shift().deviation;if(Math.abs(p)>n)return!1;c+=C.distance(m,B),f=T}return!0}static _smoothVertices(s,r){if(r<=0)return s;let a=s.length;if(a<3)return s;const n=[];let o=0,c=0;n.push(0);for(let T=1;T<a;T++){const B=C.distance(s[T],s[T-1]);B>0&&(o+=B,n.push(o),c++,c!==T&&(s[c]=s[T]))}if(a=c+1,a<3)return s;r=Math.min(r,.2*o);const h=s[0].x,u=s[0].y,f=s[a-1].x,d=s[a-1].y,p=C.sub(s[0],s[1]);p.normalize(),s[0].x+=r*p.x,s[0].y+=r*p.y,p.assignSub(s[a-1],s[a-2]),p.normalize(),s[a-1].x+=r*p.x,s[a-1].y+=r*p.y,n[0]-=r,n[a-1]+=r;const g=[];g.push(new C(h,u));const y=1e-6,m=.5*r;for(let T=1;T<a-1;T++){let B=0,_=0,b=0;for(let I=T-1;I>=0;I--){const w=m+n[I+1]-n[T];if(w<0)break;const P=n[I+1]-n[I],A=n[T]-n[I]<m?1:w/P;if(A<y)break;const M=A*A,R=A*w-.5*M*P,S=A*P/r,v=s[I+1],U=s[I].x-v.x,V=s[I].y-v.y;B+=S/R*(v.x*A*w+.5*M*(w*U-P*v.x)-M*A*P*U/3),_+=S/R*(v.y*A*w+.5*M*(w*V-P*v.y)-M*A*P*V/3),b+=S}for(let I=T+1;I<a;I++){const w=m-n[I-1]+n[T];if(w<0)break;const P=n[I]-n[I-1],A=n[I]-n[T]<m?1:w/P;if(A<y)break;const M=A*A,R=A*w-.5*M*P,S=A*P/r,v=s[I-1],U=s[I].x-v.x,V=s[I].y-v.y;B+=S/R*(v.x*A*w+.5*M*(w*U-P*v.x)-M*A*P*U/3),_+=S/R*(v.y*A*w+.5*M*(w*V-P*v.y)-M*A*P*V/3),b+=S}g.push(new C(B/b,_/b))}return g.push(new C(f,d)),s[0].x=h,s[0].y=u,s[a-1].x=f,s[a-1].y=d,g}static _pushCentroid(s,r){const o=Te,c=Te,h=r.length-1;let u=0,f=0,d=0,p=r[0].x,g=r[0].y;p>o&&(p=o),p<0&&(p=0),g>c&&(g=c),g<0&&(g=0);for(let y=1;y<h;y++){let m=r[y].x,T=r[y].y,B=r[y+1].x,_=r[y+1].y;m>o&&(m=o),m<0&&(m=0),T>c&&(T=c),T<0&&(T=0),B>o&&(B=o),B<0&&(B=0),_>c&&(_=c),_<0&&(_=0);const b=(m-p)*(_-g)-(B-p)*(T-g);u+=b*(p+m+B),f+=b*(g+T+_),d+=b}u/=3*d,f/=3*d,isNaN(u)||isNaN(f)||s.push(new $e(u,f))}};X._bidiEngine=new fs;let rt=X;var oe;(function(l){l[l.INITIALIZED=0]="INITIALIZED",l[l.NO_DATA=1]="NO_DATA",l[l.READY=2]="READY",l[l.MODIFIED=3]="MODIFIED",l[l.INVALID=4]="INVALID"})(oe||(oe={}));class Js{constructor(s,r,a,n,o,c){var p;if(this._pbfTiles={},this._tileClippers={},this._client=a,this._tile=r,this._sourceDataMaxLOD=n,c){this._styleLayerUIDs=new Set;for(const g of c)this._styleLayerUIDs.add(g)}this._styleRepository=o,this._layers=((p=this._styleRepository)==null?void 0:p.layers)??[];const[h,u,f]=r.tileKey.split("/").map(parseFloat);this._level=h;const d=Nt(this._level);for(const g of Object.keys(s)){const y=s[g];if(this._pbfTiles[g]=new Wt(new Uint8Array(y.protobuff),new DataView(y.protobuff)),y.refKey){const[m]=y.refKey.split("/").map(parseFloat),T=h-m;if(T>0){const B=(1<<T)-1,_=u&B,b=f&B;this._tileClippers[g]=new zt(T,_,b,8,d)}}this._tileClippers[g]||(this._tileClippers[g]=new Gt)}}_canParseStyleLayer(s){return!this._styleLayerUIDs||this._styleLayerUIDs.has(s)}async parse(s){const r=jt(),a=this._initialize(s),{returnedBuckets:n}=a;this._processLayers(a),this._linkReferences(a),this._filterFeatures(a);const o=[],c=new Set,h=(d,p)=>{c.has(d)||(o.push({name:d,repeat:p}),c.add(d))},u={};for(const d of n)d.getResources(d.tileClipper,h,u);if(this._tile.status===oe.INVALID)return[];const f=this._fetchResources(o,u,s);return Promise.all([...f,r]).then((()=>this._processFeatures(a.returnedBuckets)))}_initialize(s){return{signal:s==null?void 0:s.signal,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}}_processLayers(s){const{sourceNameToTileData:r,zoom:a,layers:n,sourceNameToTileClipper:o,sourceNameToUniqueSourceLayerBuckets:c,sourceNameToUniqueSourceLayers:h,returnedBuckets:u,layerIdToBucket:f,referencerUIDToReferencedId:d}=s,p=this._sourceDataMaxLOD;for(let g=n.length-1;g>=0;g--){const y=n[g];if(a<p){if(y.minzoom&&a<Math.floor(y.minzoom)||y.maxzoom&&a>=y.maxzoom)continue}else if(y.maxzoom&&a>=y.maxzoom)continue;if(y.type===ge.BACKGROUND||!this._canParseStyleLayer(y.uid)||!r[y.source]||!o[y.source])continue;const m=r[y.source],T=o[y.source],B=y.sourceLayer,_=m[B];if(_){let b=h[y.source];if(b||(b=h[y.source]=new Set),b.add(y.sourceLayer),y.refLayerId)d.set(y.uid,y.refLayerId);else{const I=this._createBucket(y);if(I){I.layerUIDs=[y.uid],I.layerExtent=_.extent,I.tileClipper=T;let w=c[y.source];w||(w=c[y.source]={});let P=w[B];P||(P=w[B]=[]),P.push(I),u.push(I),f[y.id]=I}}}}}_linkReferences(s){const{layerIdToBucket:r,referencerUIDToReferencedId:a}=s;a.forEach(((n,o)=>{r[n]&&r[n].layerUIDs.push(o)}))}_filterFeatures(s){const{signal:r,sourceNameToTileData:a,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o}=s,c=10*this._level,h=10*(this._level+1),u=[],f=[];for(const d of Object.keys(o))o[d].forEach((p=>{u.push(p),f.push(d)}));for(let d=0;d<u.length;d++){const p=f[d],g=u[d];if(!a[p]||!n[p])continue;const y=a[p][g],m=n[p][g];if(!m||m.length===0)continue;if(vt(r))return;let T=0;const B=y.getData();for(;B.nextTag(2);){const _=B.getMessage(),b=new Os(_,y,T++);_.release();const I=b.values;if(I){const w=I._minzoom;if(w&&w>=h)continue;const P=I._maxzoom;if(P&&P<=c)continue}for(const w of m)w.pushFeature(b)}}}_fetchResources(s,r,a){const n=[],o=this._tile.getWorkerTileHandler();let c,h;s.length>0&&(c=o.fetchSprites(s,this._client,a),n.push(c));for(const u in r){const f=r[u];f.size>0&&(h=o.fetchGlyphs(this._tile.tileKey,u,f,this._client,a),n.push(h))}return n}_processFeatures(s){const r=s.filter((a=>a.hasFeatures()||this._canParseStyleLayer(a.layer.uid)));for(const a of r)a.processFeatures(a.tileClipper);return r}_parseTileData(s){const r={};for(const a of Object.keys(s)){const n=s[a],o={};for(;n.next();)switch(n.tag()){case 3:{const c=n.getMessage(),h=new it(c);c.release(),o[h.name]=h;break}default:n.skip()}r[a]=o}return r}_createBucket(s){switch(s.type){case ge.BACKGROUND:return null;case ge.FILL:return this._createFillBucket(s);case ge.LINE:return this._createLineBucket(s);case ge.CIRCLE:return this._createCircleBucket(s);case ge.SYMBOL:return this._createSymbolBucket(s)}}_createFillBucket(s){return new Ks(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Ns(s.fillMaterial.getStride()),new me,new zs(s.outlineMaterial.getStride()),new me)}_createLineBucket(s){return new Ws(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new $s(s.lineMaterial.getStride()),new me)}_createCircleBucket(s){return new Hs(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Gs(s.circleMaterial.getStride()),new me)}_createSymbolBucket(s){const r=this._tile;return new rt(r.tileKey,s,this._level,new bt(s.iconMaterial.getStride()),new me,new bt(s.textMaterial.getStride()),new me,r.placementEngine,r.getWorkerTileHandler())}}let Xs=class{constructor(s,r,a,n){this.status=oe.INITIALIZED,this.placementEngine=new Es,this.tileKey=s,this.refKeys=r,this._workerTileHandler=a,this._styleRepository=n}release(){this.tileKey="",this.refKeys=null,this.status=oe.INITIALIZED,this._workerTileHandler=null}async parse(s,r){const a=r==null?void 0:r.signal;if(a!=null){const d=()=>{a.removeEventListener("abort",d),this.status=oe.INVALID};a.addEventListener("abort",d)}let n;const o={bucketsWithData:[],emptyBuckets:null};try{n=await this._parse(s,r)}catch(d){if(Bt(d))throw d;return{result:o,transferList:[]}}this.status=oe.READY;const c=o.bucketsWithData,h=[];for(const d of n)if(d.hasFeatures()){const p=d.serialize();c.push(p)}else h.push(d.layer.uid);const u=[...c];let f=null;return h.length>0&&(f=Uint32Array.from(h),u.push(f.buffer)),o.emptyBuckets=f,{result:o,transferList:u}}setObsolete(){this.status=oe.INVALID}getLayers(){return this._workerTileHandler.getLayers()}getWorkerTileHandler(){return this._workerTileHandler}async _parse(s,r){const a=s.sourceName2DataAndRefKey;return Object.keys(a).length===0?[]:(this.status=oe.MODIFIED,new Js(a,this,r.client,s.sourceDataMaxLOD,this._styleRepository,s.styleLayerUIDs).parse(r))}};const Qs=25;class _r{constructor(){this._spriteInfo={},this._glyphInfo={},this._sourceDataMaxLOD=Qs}reset(){return this._spriteInfo={},this._glyphInfo={},Promise.resolve()}getLayers(){var s;return((s=this._styleRepository)==null?void 0:s.layers)??[]}async createTileAndParse(s,r){const{key:a}=s,n={};for(const c of Object.keys(s.sourceName2DataAndRefKey)){const h=s.sourceName2DataAndRefKey[c];n[c]=h.refKey}const o=new Xs(a,n,this,this._styleRepository);try{return await o.parse({...s,sourceDataMaxLOD:this._sourceDataMaxLOD},r)}catch(c){if(o.setObsolete(),o.release(),!Bt(c))throw c;return null}}updateStyle(s){if(!s||s.length===0||!this._styleRepository)return;const r=this._styleRepository;for(const a of s){const n=a.type,o=a.data;switch(n){case Be.PAINTER_CHANGED:r.setPaintProperties(o.layer,o.paint);break;case Be.LAYOUT_CHANGED:r.setLayoutProperties(o.layer,o.layout);break;case Be.LAYER_REMOVED:r.deleteStyleLayer(o.layer);break;case Be.LAYER_CHANGED:r.setStyleLayer(o.layer,o.index);break;case Be.SPRITES_CHANGED:this._spriteInfo={}}}}setStyle(s){const{style:r,sourceDataMaxLOD:a}=s;this._styleRepository=new Ot(r),this._sourceDataMaxLOD=a,this._spriteInfo={},this._glyphInfo={}}fetchSprites(s,r,a){const n=[],o=this._spriteInfo;for(const c of s)o[c.name]===void 0&&n.push(c);return n.length===0?Promise.resolve():r.invoke("getSprites",n,{signal:a==null?void 0:a.signal}).then((c=>{for(const h in c){const u=c[h];o[h]=u}}))}getSpriteItems(){return this._spriteInfo}fetchGlyphs(s,r,a,n,o){const c=[];let h=this._glyphInfo[r];return h?a.forEach((u=>{h[u]||c.push(u)})):(h=this._glyphInfo[r]=[],a.forEach((u=>c.push(u)))),c.length===0?Promise.resolve():n.invoke("getGlyphs",{tileID:s,font:r,codePoints:c},o).then((u=>{for(let f=0;f<u.length;f++)u[f]&&(h[f]=u[f])}))}getGlyphItems(s){return this._glyphInfo[s]}}export{_r as default};
