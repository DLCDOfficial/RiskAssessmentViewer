const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./knowledgeGraphService-BdyAFpUG.js","./index-DzoQLc5A.js","./index-FMl8DCyv.css","./normalizeUtils-PTTPU64I.js","./normalizeUtilsCommon-C_a4i1bY.js","./utils-DDykF6ND.js","./utils-BRuFmAg3.js","./GPMessage-BvJMSZbN.js","./Relationship-TGvALoMr.js"])))=>i.map(i=>d[i]);
import{w as Q,cI as j,aN as A,B as g,F as R,aC as _,J as V,aY as H,v as L,dF as m,dG as d,C as k,dL as v,_ as E,dK as I,Z,cr as K,dM as J,fQ as U,am as X,dy as Y,cB as z,h2 as $,dx as tt,fP as et}from"./index-DzoQLc5A.js";import{t as rt}from"./arcadeUtils-B5o1WIuc.js";import{a as W,p as O,X as nt,q as b,j as D,l as at,A as G,F as ot,E as it,Z as st,H as B}from"./aiServices-CwoakPkn.js";import{l as pt}from"./portalUtils-J2lwjXKt.js";import{f as ct,s as ut}from"./utils-DDykF6ND.js";import{o as ft}from"./utils-BRuFmAg3.js";import{s as lt,p as mt,e as dt,i as ht,a as gt}from"./Relationship-TGvALoMr.js";import"https://js.arcgis.com/map-components/4.33/arcgis-map-components.esm.js";import"./featureConversionUtils-4vS7e9DV.js";import"./OptimizedFeature-DdLiUxBt.js";import"./memoryEstimations-Cau39Oyv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./WhereClause-C4sLVd4N.js";import"./unitConversion-BxJeRrtg.js";import"./number-BUyyDjIe.js";import"./commonProperties-DHiB1uzW.js";let p=class extends Q{constructor(t){super(t),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const t=this.geometries.map((o=>o.toJSON())),e=this.geometries[0],n={};return n.outSR=j(this.outSpatialReference),n.inSR=j(e.spatialReference),n.geometries=JSON.stringify({geometryType:A(e),geometries:t}),this.transformation&&(n.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(n.transformForward=this.transformForward),n}};g([R()],p.prototype,"geometries",void 0),g([R({type:_,json:{read:{source:"outSR"}}})],p.prototype,"outSpatialReference",void 0),g([R()],p.prototype,"transformation",void 0),g([R()],p.prototype,"transformForward",void 0),p=g([V("esri.rest.support.ProjectParameters")],p);const wt=H(p);async function yt(t,e,n){e=wt(e);const o=ct(t),i={...o.query,f:"json",...e.toJSON()},r=e.outSpatialReference,a=A(e.geometries[0]),c=ut(i,n);return L(o.path+"/project",c).then((({data:{geometries:u}})=>ft(u,a,r)))}let h=null;async function St(t){const e=X.geometryServiceUrl??"";if(!e){tt()||await Y();for(const r of t)r.container[r.indexer]=z(r.container[r.indexer],_.WGS84);return}const n=t.map((r=>r.container[r.indexer])),o=new p({geometries:n,outSpatialReference:_.WGS84}),i=await yt(e,o);for(let r=0;r<i.length;r++){const a=t[r];a.container[a.indexer]=i[r]}}async function q(t,e){const n=new Z({portal:t,id:e});return await n.load(),h===null&&(h=await E(()=>import("./knowledgeGraphService-BdyAFpUG.js").then(o=>o.k),__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url)),await h.fetchKnowledgeGraph(n.url)}function P(t,e,n,o,i){if(t===null)return null;if(v(t)||K(t))return t;if(G(t)||G(t))return t.toJSDate();if(ot(t))return t.toStorageFormat();if(it(t))return t.toStorageString();if(st(t)){const r={};for(const a of t.keys())r[a]=P(t.field(a),e,n,o,i),r[a]instanceof J&&i.push({container:r,indexer:a});return r}if(I(t)){const r=t.map((a=>P(a,e,n,o,i)));for(let a=0;a<r.length;a++)r[a]instanceof J&&i.push({container:r,indexer:a});return r}return B(t)?t.spatialReference.isWGS84?t:t.spatialReference.isWebMercator&&e?U(t):t:void 0}function Rt(t,e){if(!t)return t;if(t.spatialReference.isWGS84&&e.spatialReference.isWebMercator)return et(t);if(t.spatialReference.equals(e.spatialReference))return t;throw new m(e,d.WrongSpatialReference,null)}function F(t,e){if(!t)return null;const n={};for(const o in t)n[o]=w(t[o],e);return n}function w(t,e){return t===null?null:I(t)?t.map((n=>w(n,e))):t instanceof mt?{graphTypeName:t.typeName,id:t.id,graphType:"entity",properties:F(t.properties,e)}:t instanceof dt?{graphType:"object",properties:F(t.properties,e)}:t instanceof ht?{graphTypeName:t.typeName,id:t.id,graphType:"relationship",originId:t.originId??null,destinationId:t.destinationId??null,properties:F(t.properties,e)}:t instanceof gt?{graphType:"path",path:t.path?t.path.map((n=>w(n,e))):null}:B(t)?Rt(t,e):v(t)||K(t)||$(t)?t:null}function qt(t){t.mode==="async"&&(t.functions.knowledgegraphbyportalitem=function(e,n){return t.standardFunctionAsync(e,n,((o,i,r)=>{var c,u;if(W(r,2,2,e,n),r[0]===null)throw new m(e,d.PortalRequired,n);if(r[0]instanceof rt){const l=O(r[1]);let y;return y=(c=e.services)!=null&&c.portal?e.services.portal:k.getDefault(),q(pt(r[0],y),l)}if(v(r[0])===!1)throw new m(e,d.InvalidParameter,n);const a=O(r[0]);return q(((u=e.services)==null?void 0:u.portal)??k.getDefault(),a)}))},t.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),t.functions.querygraph=function(e,n){return t.standardFunctionAsync(e,n,(async(o,i,r)=>{var T;W(r,2,4,e,n);const a=r[0];if(!nt(a))throw new m(e,d.InvalidParameter,n);const c=r[1];if(!v(c))throw new m(e,d.InvalidParameter,n);h===null&&(h=await E(()=>import("./knowledgeGraphService-BdyAFpUG.js").then(s=>s.k),__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url));let u=null;const l=b(r[2],null);if(!(l instanceof D||l===null))throw new m(e,d.InvalidParameter,n);if(l){let s=[];u=P(l,!0,!1,e,s),s=s.filter((f=>!f.container[f.indexer].spatialReference.isWGS84)),s.length>0&&await St(s)}const y=b(r[3],!1),N=new lt({openCypherQuery:c,bindParameters:u,provenanceBehavior:y?"include":"exclude"});(((T=a==null?void 0:a.serviceDefinition)==null?void 0:T.currentVersion)??11.3)>11.2&&(N.outputSpatialReference=e.spatialReference);const C=(await h.executeQueryStreaming(a,N)).resultRowsStream.getReader(),x=[];try{for(;;){const{done:s,value:f}=await C.read();if(s)break;if(I(f))for(const S of f)x.push(w(S,e));else{const S=[];for(const M of f)S.push(w(f[M],e));x.push(S)}}}catch(s){throw s}return D.convertJsonToArcade(x,at(e),!1,!0)}))},t.signatures.push({name:"querygraph",min:2,max:4}))}export{qt as registerFunctions};
