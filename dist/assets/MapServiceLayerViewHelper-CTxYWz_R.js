const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Bdk4Sca1.js","./index-DE10eTWw.css"])))=>i.map(i=>d[i]);
import{gk as W,aR as H,L as B,eB as X,fj as Y,g2 as ee,dU as Q,J,U as te,P as n,Q as p,aC as re,bC as ie,X as z,V as q,v as se,af as oe,T as I,aB as k,jc as ae,cN as ne,Y as le,aS as ue,$ as pe,Z as ye,a0 as ce,dT as de,a8 as he,dn as fe,s as A,fK as U,_ as me,cc as ge,d0 as be,dy as we,aa as ve,h8 as xe,at as M,mO as Se,b$ as Fe}from"./index-Bdk4Sca1.js";import{n as T}from"./floorFilterUtils-MtPgm5NF.js";import{o as L}from"./drapedUtils-BCTwlfiF.js";import{i as $e}from"./sublayerUtils-D2C4thEk.js";import{n as Pe,p as Ve}from"./popupUtils-C8RxDmzv.js";function ze(a){if(!a)return[];let e=W(a)?[a]:H.isCollection(a)?a.toArray():Array.isArray(a)?a:[];return e=e==null?void 0:e.filter(B),((e==null?void 0:e.length)??0)===0?[]:e}function _e(a,e){const{dpi:i,gdbVersion:r,geometry:t,geometryPrecision:o,height:h,historicMoment:s,layerOption:y,mapExtent:c,maxAllowableOffset:l,returnFieldName:d,returnGeometry:u,returnUnformattedValues:b,returnZ:F,spatialReference:$,timeExtent:m,tolerance:V,width:v}=a.toJSON(),{dynamicLayers:g,layerDefs:x,layerIds:j}=Oe(a),O=(e==null?void 0:e.geometry)!=null?e.geometry:null,w={historicMoment:s,geometryPrecision:o,maxAllowableOffset:l,returnFieldName:d,returnGeometry:u,returnUnformattedValues:b,returnZ:F,tolerance:V},S=(O==null?void 0:O.toJSON())||t;w.imageDisplay=`${v},${h},${i}`,r&&(w.gdbVersion=r),S&&(delete S.spatialReference,w.geometry=JSON.stringify(S),w.geometryType=X(S));const E=$??(S==null?void 0:S.spatialReference)??(c==null?void 0:c.spatialReference);if(E&&(w.sr=Y(E)),w.time=m?[m.start,m.end].join(","):null,c){const{xmin:R,ymin:Z,xmax:C,ymax:K}=c;w.mapExtent=`${R},${Z},${C},${K}`}return x&&(w.layerDefs=x),g&&!x&&(w.dynamicLayers=g),w.layers=y==="popup"?"visible":y,j&&!g&&(w.layers+=`:${j.join(",")}`),w}function Oe(a){var F,$;const{mapExtent:e,floors:i,width:r,sublayers:t,layerIds:o,layerOption:h,gdbVersion:s}=a,y=($=(F=t==null?void 0:t.find((m=>m.layer!=null)))==null?void 0:F.layer)==null?void 0:$.serviceSublayers,c=h==="popup",l={},d=ee({extent:e,width:r,spatialReference:e==null?void 0:e.spatialReference}),u=[],b=m=>{const V=d===0,v=m.minScale===0||d<=m.minScale,g=m.maxScale===0||d>=m.maxScale;if(m.visible&&(V||v&&g))if(m.sublayers)m.sublayers.forEach(b);else{if((o==null?void 0:o.includes(m.id))===!1||c&&(!m.popupTemplate||!m.popupEnabled))return;u.unshift(m)}};if(t==null||t.forEach(b),t&&!u.length)l.layerIds=[];else{const m=$e(u,y,s),V=u.map((v=>{const g=T(i,v);return v.toExportImageJSON(g)}));if(m)l.dynamicLayers=JSON.stringify(V);else{if(t){let g=u.map((({id:x})=>x));o&&(g=g.filter((x=>o.includes(x)))),l.layerIds=g}else o!=null&&o.length&&(l.layerIds=o);const v=je(i,u);if(v!=null&&v.length){const g={};for(const x of v)x.definitionExpression&&(g[x.id]=x.definitionExpression);Object.keys(g).length&&(l.layerDefs=JSON.stringify(g))}}}return l}function je(a,e){const i=!!(a!=null&&a.length),r=e.filter((t=>t.definitionExpression!=null||i&&t.floorInfo!=null));return r.length?r.map((t=>{const o=T(a,t),h=Q(o,t.definitionExpression);return{id:t.id,definitionExpression:h??void 0}})):null}var N;let f=N=class extends J{static from(a){return te(N,a)}constructor(a){super(a),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(a,e){e.historicMoment=a&&a.getTime()}};n([p({type:Number,json:{write:!0}})],f.prototype,"dpi",void 0),n([p()],f.prototype,"floors",void 0),n([p({type:String,json:{write:!0}})],f.prototype,"gdbVersion",void 0),n([p({types:ie,json:{read:re,write:!0}})],f.prototype,"geometry",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"geometryPrecision",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"height",void 0),n([p({type:Date})],f.prototype,"historicMoment",void 0),n([z("historicMoment")],f.prototype,"writeHistoricMoment",null),n([p({type:[Number],json:{write:!0}})],f.prototype,"layerIds",void 0),n([p({type:["top","visible","all","popup"],json:{write:!0}})],f.prototype,"layerOption",void 0),n([p({type:q,json:{write:!0}})],f.prototype,"mapExtent",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"maxAllowableOffset",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnFieldName",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnGeometry",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnM",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnUnformattedValues",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnZ",void 0),n([p({type:se,json:{write:!0}})],f.prototype,"spatialReference",void 0),n([p({type:H})],f.prototype,"sublayers",void 0),n([p({type:oe,json:{write:!0}})],f.prototype,"timeExtent",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"tolerance",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"width",void 0),f=N=n([I("esri.rest.support.IdentifyParameters")],f);const D=f;let P=class extends J{constructor(a){super(a),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(a,e){return k.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(a,e){if(!a)return;const{attributes:i,geometry:r}=a;i&&(e.attributes={...i}),r!=null&&(e.geometry=r.toJSON(),e.geometryType=ae.toJSON(r.type))}};n([p({type:String,json:{write:!0}})],P.prototype,"displayFieldName",void 0),n([p({type:k})],P.prototype,"feature",void 0),n([ne("feature",["attributes","geometry"])],P.prototype,"readFeature",null),n([z("feature")],P.prototype,"writeFeature",null),n([p({type:Number,json:{write:!0}})],P.prototype,"layerId",void 0),n([p({type:String,json:{write:!0}})],P.prototype,"layerName",void 0),P=n([I("esri.rest.support.IdentifyResult")],P);const Ee=P;async function Re(a,e,i){const r=(e=Ne(e)).geometry?[e.geometry]:[],t=le(a);return t.path+="/identify",ue(r).then((o=>{const h=_e(e,{geometry:o==null?void 0:o[0]}),s=pe({...t.query,f:"json",...h}),y=ye(s,i);return ce(t.path,y).then(Ge).then((c=>Ie(c,e.sublayers)))}))}function Ge(a){const e=a.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map((i=>Ee.fromJSON(i))),e}function Ne(a){return a=D.from(a)}function Ie(a,e){if(!(e!=null&&e.length))return a;const i=new Map;function r(t){i.set(t.id,t),t.sublayers&&t.sublayers.forEach(r)}e.forEach(r);for(const t of a.results)t.feature.sourceLayer=i.get(t.layerId);return a}let G=null;function qe(a,e){return e.type==="tile"||e.type==="map-image"}let _=class extends de{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=he((async i=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(i).catch((()=>{})))}))}initialize(){const e=i=>{var r;for(const t of i){const{sourceLayer:o}=t;o!=null&&"geometryType"in o&&o.geometryType==="point"&&t.visible&&(t.visible=!1,(r=this.highlightGraphicUpdated)==null||r.call(this,{graphic:t,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(i).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([fe((()=>this.highlightGraphics),"change",(i=>e(i.added)),{onListenerAdd:i=>e(i)})])}async fetchPopupFeaturesAtLocation(e,i){var s,y;const{layerView:{layer:r,view:{scale:t}}}=this;if(!e)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const o=Te(r.sublayers,t,i);if(!o.length)return[];const h=await Ue(r,o);if(!((((y=(s=r.capabilities)==null?void 0:s.operations)==null?void 0:y.supportsIdentify)??!0)&&r.version>=10.5)&&!h)throw new A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return h?this._fetchPopupFeaturesUsingQueries(e,o,i):this._fetchPopupFeaturesUsingIdentify(e,o,i)}clearHighlights(){var e;(e=this.highlightGraphics)==null||e.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const i of e)this._updateSymbology(i)}_updateSymbology(e){var i;if(((i=e.geometry)==null?void 0:i.type)==="point")return this._updatePointSymbology(e)}_setGraphicSymbol(e,i){var t;if(!i)return;const r=e.symbol;e.symbol=i,(t=this.highlightGraphicUpdated)==null||t.call(this,{graphic:e,property:"symbol",oldValue:r,newValue:i})}_updatePointSymbology(e){const i=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:r,highlightGraphics:t,layerView:{view:o}}=this,h=s=>{s.visible||(s.visible=!0,r==null||r({graphic:s,property:"visible",oldValue:!1,newValue:!0}))};i&&"getSymbolAsync"in i?i.getSymbolAsync(e).then((async s=>{var l;s||(s=new U);let y=null;const c="visualVariables"in i?(l=i.visualVariables)==null?void 0:l.find((d=>d.type==="size")):void 0;c&&(G||(G=(await me(async()=>{const{getSize:d}=await import("./index-Bdk4Sca1.js").then(u=>u.vC);return{getSize:d}},__vite__mapDeps([0,1]),import.meta.url)).getSize),y=G(c,e,{view:o.type,scale:o.scale,shape:s.type==="simple-marker"?s.style:null})),y||(y="width"in s&&"height"in s&&s.width!=null&&s.height!=null?Math.max(s.width,s.height):"size"in s?s.size:16),t!=null&&t.includes(e)&&(this._setGraphicSymbol(e,new U({style:"square",size:y,color:new ge([255,255,255,1/255]),xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0})),h(e))})):h(e)}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:i,view:r},highlightGraphics:t,highlightGraphicUpdated:o}=this;if(this._highlightGeometriesResolution=e,!o||!(t!=null&&t.length)||!i.capabilities.operations.supportsQuery)return;const h=this._getTargetResolution(e),s=new Map;for(const l of t)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>h){const d=l.sourceLayer;be(s,d,(()=>new Map)).set(l.getObjectId(),l)}const y=Array.from(s,(([l,d])=>{const u=l.createQuery();return u.objectIds=[...d.keys()],u.outFields=[l.objectIdField],u.returnGeometry=!0,u.maxAllowableOffset=h,u.outSpatialReference=r.spatialReference,l.queryFeatures(u)})),c=await Promise.all(y);if(!this.destroyed)for(const{features:l}of c)for(const d of l){const u=d.sourceLayer,b=s.get(u).get(d.getObjectId());if(b&&t.includes(b)){const F=b.geometry;b.geometry=d.geometry,o({graphic:b,property:"geometry",oldValue:F,newValue:b.geometry}),this._featuresResolutions.set(b,h)}}}_getTargetResolution(e){const i=e*we(this.layerView.view.spatialReference),r=i/16;return r<=10?0:e/i*r}async _fetchPopupFeaturesUsingIdentify(e,i,r){const t=await this._createIdentifyParameters(e,i,r);if(t==null)return[];const{results:o}=await Re(this.layerView.layer.parsedUrl,t,r);return o.map((h=>h.feature))}async _createIdentifyParameters(e,i,r){const{floors:t,layer:o,timeExtent:h,view:{spatialReference:s,scale:y}}=this.layerView;if(!i.length)return null;await Promise.all(i.map((({sublayer:F})=>F.load(r).catch((()=>{})))));const c=Math.min(ve("mapservice-popup-identify-max-tolerance"),o.allSublayers.reduce(((F,$)=>$.renderer?L({renderer:$.renderer,pointerType:r==null?void 0:r.pointerType}):F),2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),d=xe(y,s),u=Math.round(l.width/d),b=new q({xmin:l.center.x-d*u,ymin:l.center.y-d*u,xmax:l.center.x+d*u,ymax:l.center.y+d*u,spatialReference:l.spatialReference});return new D({floors:t,gdbVersion:"gdbVersion"in o?o.gdbVersion:void 0,geometry:e,height:u,layerOption:"popup",mapExtent:b,returnGeometry:!0,spatialReference:s,sublayers:o.sublayers,timeExtent:h,tolerance:c,width:u})}async _fetchPopupFeaturesUsingQueries(e,i,r){const{layerView:{floors:t,timeExtent:o}}=this,h=i.map((async({sublayer:s,popupTemplate:y})=>{var j,O,w;if(await s.load(r).catch((()=>{})),s.capabilities&&!s.capabilities.operations.supportsQuery)return[];const c=s.createQuery(),l=L({renderer:s.renderer,pointerType:r==null?void 0:r.pointerType}),d=this.createFetchPopupFeaturesQueryGeometry(e,l),u=new Set,[b]=await Promise.all([Pe(s,y),(j=s.renderer)==null?void 0:j.collectRequiredFields(u,s.fieldsIndex)]);M(r),Se(u,s.fieldsIndex,b);const F=Array.from(u).sort();c.geometry=d,c.outFields=F,c.timeExtent=o;const $=T(t,s);if(c.where=Q(c.where,$),((O=s.capabilities)==null?void 0:O.query.supportsOrderBy)&&((w=s.orderBy)==null?void 0:w[0])){const S=s.orderBy[0],E=!S.valueExpression&&S.field,R=S.order==="ascending"?"asc":"desc";E&&(c.orderByFields=[`${E} ${R}`])}const m=this._getTargetResolution(d.width/l),V=await Ae(y);M(r);const v=s.geometryType==="point"||V&&V.arcadeUtils.hasGeometryOperations(y);v||(c.maxAllowableOffset=m);let{features:g}=await s.queryFeatures(c,r);const x=v?0:m;g=await Me(s,g,r);for(const S of g)this._featuresResolutions.set(S,x);return g}));return(await Promise.allSettled(h)).reduce(((s,y)=>y.status==="fulfilled"?[...s,...y.value]:s),[]).filter(B)}};function Te(a,e,i){const r=[];if(!a)return r;const t=o=>{const h=o.minScale===0||e<=o.minScale,s=o.maxScale===0||e>=o.maxScale;if(o.visible&&h&&s){if(o.sublayers)o.sublayers.forEach(t);else if(o.popupEnabled){const y=Ve(o,{...i,defaultPopupTemplateEnabled:!1});y!=null&&r.unshift({sublayer:o,popupTemplate:y})}}};return a.map(t),r}function Ae(a){var e;return(e=a.expressionInfos)!=null&&e.length||Array.isArray(a.content)&&a.content.some((i=>i.type==="expression"))?Fe():Promise.resolve()}async function Ue(a,e){var i,r;if((r=(i=a.capabilities)==null?void 0:i.operations)!=null&&r.supportsQuery)return!0;try{return await Promise.any(e.map((({sublayer:t})=>t.load().then((()=>t.capabilities.operations.supportsQuery)))))}catch{return!1}}async function Me(a,e,i){const r=a.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(e=r.valueExpression?await Promise.all(e.map((t=>r.getSymbolAsync(t,i).then((o=>o?t:null))))).then((t=>t.filter((o=>o!=null)))):e.filter((t=>r.getSymbol(t)!=null))),e}n([p({constructOnly:!0})],_.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),n([p({constructOnly:!0})],_.prototype,"layerView",void 0),n([p({constructOnly:!0})],_.prototype,"highlightGraphics",void 0),n([p({constructOnly:!0})],_.prototype,"highlightGraphicUpdated",void 0),n([p({constructOnly:!0})],_.prototype,"updatingHandles",void 0),_=n([I("esri.views.layers.support.MapServiceLayerViewHelper")],_);export{_ as P,qe as _,ze as i};
